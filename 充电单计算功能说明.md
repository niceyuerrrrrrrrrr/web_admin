# 充电单列表计算功能说明

## 功能概述

在充电单列表的操作列中新增了"计算金额"按钮，支持对充电单数据进行自动计算，并显示充电站的时段电价表信息。

## 功能特性

### 1. 计算按钮
- **位置**：每条充电单记录的操作列
- **图标**：计算器图标（CalculatorOutlined）
- **功能**：点击后触发计算流程

### 2. 计算前验证
系统会自动验证充电单数据的完整性：
- ✅ 充电站信息必须存在
- ✅ 充电时间必须存在
- ✅ 充电电量必须大于0

如果数据不完整，会提示用户无法计算。

### 3. 电价表确认对话框

点击"计算金额"按钮后，会弹出对话框显示：

#### 充电单信息
- 充电站名称（高亮显示）
- 充电桩编号
- 充电时间
- 充电电量（绿色高亮）
- 识别金额
- 当前计算金额（如果已计算过）

#### 电价规则说明
- 提示系统将根据充电时间和电量自动计算
- 说明会使用该充电站在充电时间点生效的电价规则
- 引导用户前往"充电站管理"页面查看详细规则

### 4. 计算结果对话框

计算完成后显示：

#### 计算结果
- **计算金额**：金色高亮显示，精确到分（2位小数）
- **计算单价**：绿色显示，精确到4位小数（元/kWh）
- **充电电量**：显示用于计算的电量

#### 对比信息
- **识别金额**：OCR识别的原始金额
- **金额差异**：
  - 正差异（识别金额 > 计算金额）：红色显示，带"+"号
  - 负差异（识别金额 < 计算金额）：绿色显示
  - 无差异：默认颜色
- **原计算金额**：如果之前已计算过，显示旧的计算结果

#### 操作按钮
- **取消**：关闭对话框，不保存计算结果
- **应用计算结果**：确认使用计算结果更新充电单

### 5. 应用计算结果

点击"应用计算结果"后：
1. 弹出二次确认对话框
2. 显示即将更新的计算金额和单价
3. 确认后更新充电单的以下字段：
   - `calculated_amount`：计算金额
   - `calculated_unit_price`：计算单价
4. **原识别金额不会被修改**
5. 更新成功后：
   - 显示成功提示
   - 关闭所有对话框
   - 自动刷新列表数据

## 技术实现

### API调用
- **计算API**：`POST /charging-pricing/calculate`
  - 参数：
    - `station_name`：充电站名称
    - `charging_time`：充电时间
    - `energy_kwh`：充电电量
    - `charging_receipt_id`：充电单ID
  - 返回：
    - `amount`：计算金额
    - `price_per_kwh`：计算单价

- **更新API**：`PUT /receipts/charging/{id}`
  - 参数：
    - `calculated_amount`：计算金额
    - `calculated_unit_price`：计算单价

### 状态管理
- `calculatingReceipt`：当前正在计算的充电单
- `pricingRulesModalOpen`：电价表确认对话框状态
- `calculationResult`：计算结果数据
- `resultModalOpen`：结果对话框状态

### 用户体验优化
1. **加载状态**：计算和更新时显示loading状态
2. **错误处理**：API调用失败时显示友好的错误提示
3. **数据验证**：计算前验证数据完整性
4. **二次确认**：应用结果前需要用户确认
5. **视觉反馈**：
   - 金额差异用颜色区分正负
   - 重要数据高亮显示
   - 使用图标增强可读性

## 使用流程

```
1. 用户在充电单列表中找到需要计算的记录
   ↓
2. 点击操作列的"计算金额"按钮
   ↓
3. 系统验证数据完整性
   ↓
4. 弹出电价表确认对话框，显示充电单信息
   ↓
5. 用户确认后，点击"确定"按钮
   ↓
6. 系统调用计算API，根据时段电价规则计算
   ↓
7. 显示计算结果对话框，包含详细的计算结果和对比信息
   ↓
8. 用户查看结果，决定是否应用
   ↓
9. 点击"应用计算结果"
   ↓
10. 二次确认对话框
   ↓
11. 确认后更新充电单数据
   ↓
12. 显示成功提示，刷新列表
```

## 注意事项

1. **数据完整性**：确保充电单包含充电站、时间和电量信息
2. **电价规则**：计算依赖于充电站管理中配置的时段电价规则
3. **原始数据保护**：识别金额不会被修改，只更新计算字段
4. **权限控制**：继承充电单列表的编辑权限
5. **网络异常**：如果API调用失败，会显示错误提示，不会更新数据

## 相关页面

- **充电单列表**：`/charging/list`
- **充电站管理**：`/charging/stations`（配置时段电价规则）
- **充电数据分析**：`/charging/stats`（查看统计数据）

## 后续优化建议

1. 支持批量计算选中的充电单
2. 在电价表确认对话框中直接显示具体的电价规则
3. 添加计算历史记录功能
4. 支持手动调整计算参数（如指定电价）
5. 导出时包含计算详情

