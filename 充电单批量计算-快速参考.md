# 充电单批量计算功能 - 快速参考

## 🎯 功能概述

在充电单列表页面新增**批量计算金额**功能，支持：
- ✅ 多选充电单进行批量计算
- ✅ 显示每条记录的计算单价和生效日期
- ✅ 自动使用正确生效日期的电价规则
- ✅ 选择性应用计算结果
- ✅ 实时显示计算进度

---

## 🚀 快速使用

### 1. 选择充电单（3种方式）

**方式1：手动勾选**
```
☑ 充电单1
☑ 充电单2
☐ 充电单3
```

**方式2：快捷选择**
- 点击表格左上角下拉菜单
- 选择"全选所有数据"或"选择当前页"

**方式3：筛选后全选**
- 使用筛选条件缩小范围
- 点击"全选所有数据"

### 2. 批量计算

点击顶部的 **"批量计算金额"** 按钮

```
┌─────────────────────────────────────┐
│ 已选择 15 条记录                     │
│ [批量计算金额] [导出选中] [清空选择] │
└─────────────────────────────────────┘
```

### 3. 查看结果

计算完成后弹出结果对话框：

```
┌──────────────────────────────────────────┐
│ 批量计算结果 (15 条)              [X]    │
├──────────────────────────────────────────┤
│ ℹ️ 成功计算 13 条，失败 2 条              │
│                                          │
│ [全选成功项] [取消全选]                  │
│                                          │
│ ☑ 成功 | 单据编号 | 车牌号 | 充电站 ... │
│ ☑ 成功 | 6101... | 陕A21096D | 中建... │
│ ☐ 失败 | 6101... | 陕A26991D | 无充电站 │
│                                          │
│        [取消] [应用选中的计算结果 (13)]  │
└──────────────────────────────────────────┘
```

### 4. 应用结果

- 勾选要应用的结果
- 点击"应用选中的计算结果"
- 确认后自动更新数据库

---

## 📊 结果表格说明

| 列名 | 说明 | 示例 |
|------|------|------|
| 选择 | 勾选框 | ☑ / ☐ |
| 状态 | 成功/失败 | 🟢 成功 / 🔴 失败 |
| 单据编号 | 充电单编号 | 61012500060003 |
| 车牌号 | 车辆信息 | 陕A21096D |
| 充电站 | 充电站名称 | 中建西部... |
| 充电时间 | 开始时间 | 2026-01-26 13:20 |
| 电量(kWh) | 充电电量 | 260.22 |
| 识别金额 | OCR识别 | ¥320.00 |
| **计算金额** | **系统计算** | **¥320.47** 🟡 |
| **计算单价** | **单价+日期** | **¥1.2320/kWh**<br>生效日期: 2026-01-15 🟢 |
| 金额差异 | 差值 | +¥0.47 🔴 / -¥0.47 🟢 |
| 错误信息 | 失败原因 | 未找到充电站 |

---

## 💡 使用技巧

### 技巧1：分批处理
```
第1批：2026-01-01 ~ 2026-01-10 (20条)
第2批：2026-01-11 ~ 2026-01-20 (20条)
第3批：2026-01-21 ~ 2026-01-31 (20条)
```

### 技巧2：按充电站分组
```
1. 筛选充电站：中建西部...
2. 全选该充电站的充电单
3. 批量计算
4. 验证单价是否一致
```

### 技巧3：验证准确性
```
1. 先单独计算1条 → 查看详细电价表
2. 确认计算逻辑正确
3. 再批量计算同类充电单
```

### 技巧4：处理失败项
```
1. 查看失败原因
2. 编辑充电单补充信息
3. 重新选择并计算
```

---

## ⚠️ 注意事项

### 计算条件（必须满足）

✅ **充电站信息**
- 充电站名称不为空
- 能匹配到数据库中的充电站

✅ **充电时间**
- 充电开始时间不为空
- 用于匹配时段电价

✅ **电量信息**
- 电量 > 0
- 用于计算总金额

### 常见失败原因

❌ **充电站信息缺失**
```
解决：编辑充电单，补充充电站名称
```

❌ **充电站未配置电价规则**
```
解决：前往"充电站管理"配置电价规则
```

❌ **充电站名称不匹配**
```
解决：检查名称是否一致，或添加别名
```

❌ **充电时间超出电价规则有效期**
```
解决：添加覆盖该时间段的电价规则
```

---

## 🔧 API 说明

### 计算接口

**请求：**
```typescript
POST /api/v1/charging-pricing/calculate
{
  station_name: string
  charging_time: string  // ISO 8601
  energy_kwh: number
  charging_receipt_id: number
}
```

**响应：**
```typescript
{
  success: true,
  data: {
    price_per_kwh: number        // 单价
    amount: number               // 总金额
    rule_effective_date?: string // 生效日期
    rule_expiry_date?: string    // 失效日期
    time_period?: string         // 时段
  }
}
```

### 更新接口

**请求：**
```typescript
PUT /api/v1/receipts/charging/{id}
{
  calculated_amount: number
  calculated_unit_price: number
}
```

---

## 📝 前端代码说明

### 关键状态

```typescript
// 批量计算相关状态
const [batchCalculating, setBatchCalculating] = useState(false)
const [batchResults, setBatchResults] = useState<Array<{
  receipt: Receipt
  result?: ChargingCostResult
  error?: string
  selected: boolean
}>>([])
const [batchResultModalOpen, setBatchResultModalOpen] = useState(false)
```

### 核心函数

**1. 批量计算**
```typescript
const handleBatchCalculate = async () => {
  // 1. 验证选中的充电单
  // 2. 检查数据完整性
  // 3. 执行批量计算
  // 4. 显示结果对话框
}
```

**2. 执行计算**
```typescript
const executeBatchCalculate = async (receipts: Receipt[]) => {
  for (const receipt of receipts) {
    try {
      const result = await calculateChargingCost({...})
      results.push({ receipt, result, selected: true })
    } catch (error) {
      results.push({ receipt, error: error.message, selected: false })
    }
  }
}
```

**3. 应用结果**
```typescript
const handleApplyBatchResults = async () => {
  const selectedResults = batchResults.filter(r => r.selected && r.result)
  
  for (const item of selectedResults) {
    await updateChargingReceipt(item.receipt.id, {
      calculated_amount: item.result.amount,
      calculated_unit_price: item.result.price_per_kwh,
    })
  }
}
```

---

## 🎨 UI 组件

### 批量计算按钮

```tsx
<Button 
  size="small" 
  type="primary"
  icon={<CalculatorOutlined />} 
  onClick={handleBatchCalculate}
  loading={batchCalculating}
>
  批量计算金额
</Button>
```

### 结果表格

```tsx
<Table
  dataSource={batchResults}
  columns={[
    { title: '选择', render: (_, record, index) => (
      <input type="checkbox" checked={record.selected} 
        onChange={() => toggleBatchResultSelection(index)} />
    )},
    { title: '状态', render: (_, record) => (
      record.result ? <Tag color="success">成功</Tag> : <Tag color="error">失败</Tag>
    )},
    { title: '计算单价', render: (_, record) => (
      record.result && (
        <Space direction="vertical" size={0}>
          <Text strong style={{ color: '#52c41a' }}>
            ¥{record.result.price_per_kwh.toFixed(4)}/kWh
          </Text>
          {record.result.rule_effective_date && (
            <Text type="secondary" style={{ fontSize: 11 }}>
              生效日期: {dayjs(record.result.rule_effective_date).format('YYYY-MM-DD')}
            </Text>
          )}
        </Space>
      )
    )},
    // ... 其他列
  ]}
/>
```

---

## 🧪 测试步骤

### 测试1：基本功能

1. 选择3条充电单
2. 点击"批量计算金额"
3. 验证：
   - ✅ 显示计算进度
   - ✅ 显示结果对话框
   - ✅ 成功的默认选中
   - ✅ 失败的显示原因

### 测试2：选择性应用

1. 在结果对话框中取消勾选1条
2. 点击"应用选中的计算结果"
3. 验证：
   - ✅ 只更新选中的充电单
   - ✅ 未选中的不更新
   - ✅ 列表自动刷新

### 测试3：失败处理

1. 选择一条缺少充电站信息的充电单
2. 批量计算
3. 验证：
   - ✅ 显示失败状态
   - ✅ 显示错误信息
   - ✅ 无法勾选失败项

### 测试4：大批量处理

1. 选择50条充电单
2. 批量计算
3. 验证：
   - ✅ 显示实时进度（1/50, 2/50...）
   - ✅ 计算完成后显示统计
   - ✅ 结果表格支持分页

---

## 📈 性能优化

### 当前性能

- 单条计算：~0.5-1秒
- 20条：~10-20秒
- 50条：~25-50秒
- 100条：~50-100秒

### 优化建议

**1. 分批处理**
```typescript
// 每批20条，避免一次处理过多
const BATCH_SIZE = 20
```

**2. 并发控制**
```typescript
// 同时计算3条，提高效率
const CONCURRENT_LIMIT = 3
```

**3. 缓存电价规则**
```typescript
// 相同充电站的规则可以缓存
const priceRuleCache = new Map()
```

---

## 🔄 后续优化计划

### 短期（1-2天）

- [ ] 添加计算进度条
- [ ] 支持取消批量计算
- [ ] 优化错误提示信息

### 中期（1周）

- [ ] 添加计算历史记录
- [ ] 支持导出计算结果
- [ ] 添加计算日志查看

### 长期（1个月）

- [ ] 智能推荐需要重新计算的充电单
- [ ] 自动检测电价规则变更
- [ ] 批量计算性能优化（并发）

---

## 📞 常见问题

### Q1: 批量计算很慢怎么办？

**A:** 分批处理
- 每次不超过20-30条
- 使用筛选条件缩小范围
- 避免在高峰期执行

### Q2: 计算结果不准确？

**A:** 检查电价规则
- 前往"充电站管理"查看电价规则
- 确认单价、时段、生效日期
- 验证充电站是否匹配正确

### Q3: 可以撤销已应用的结果吗？

**A:** 可以
- 方式1：手动编辑充电单
- 方式2：重新批量计算并应用

### Q4: 失败的充电单怎么处理？

**A:** 补充信息后重新计算
- 编辑充电单补充缺失信息
- 重新选择并批量计算
- 或者联系管理员配置电价规则

---

## ✅ 功能清单

- [x] 多选充电单
- [x] 批量计算金额
- [x] 显示计算单价
- [x] 显示生效日期
- [x] 显示计算进度
- [x] 显示成功/失败统计
- [x] 选择性应用结果
- [x] 全选/取消全选
- [x] 错误信息提示
- [x] 自动刷新列表
- [x] 金额差异对比
- [x] 结果表格分页

---

*充电单批量计算功能 - 快速参考 v1.0*  
*最后更新：2026-01-26*

