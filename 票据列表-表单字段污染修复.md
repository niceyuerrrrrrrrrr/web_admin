# 票据列表 - 表单字段污染修复

## 🐛 问题描述

**错误信息：**
```
更新出厂单失败: 'DepartureReceipt' object has no attribute 'calculated_amount'
```

**问题现象：**
- 编辑出厂单时报错
- 错误提示出厂单对象没有 `calculated_amount` 属性
- 这个字段是充电单特有的，不应该出现在出厂单中

---

## 🔍 问题分析

### 根本原因：表单字段污染

**问题流程：**
1. 用户先编辑了一个**充电单**
   - 表单中包含：`receipt_number`, `vehicle_no`, `charging_station`, `energy_kwh`, `amount`, `start_time`, `end_time`, `duration_min`
   - 表单状态中保存了这些字段的值

2. 用户接着编辑一个**出厂单**
   - 调用 `editForm.setFieldsValue()` 设置出厂单字段
   - 但**没有清除**之前充电单的字段
   - 表单中仍然残留着充电单的字段值

3. 提交出厂单时
   - 使用 `...values` 获取表单所有字段
   - 包括了残留的充电单字段（如 `calculated_amount`）
   - 后端收到这些不属于出厂单的字段，导致报错

### 代码问题

**原代码（有问题）：**
```typescript
const openEdit = useCallback((receipt: Receipt) => {
  if (!canEditDelete) {
    message.warning('司机无权限编辑票据')
    return
  }
  setEditingReceipt(receipt)
  setEditDrawerOpen(true)

  if (receipt.type === 'loading') {
    // 设置装料单字段
    editForm.setFieldsValue({ ... })
  } else if (receipt.type === 'charging') {
    // 设置充电单字段
    editForm.setFieldsValue({ ... })
  } else if (receipt.type === 'departure') {
    // 设置出厂单字段
    editForm.setFieldsValue({ ... })
  }
  // ❌ 问题：没有清除之前的字段
}, [editForm, canEditDelete, message])
```

**问题：**
- `setFieldsValue` 只会**设置或更新**指定的字段
- 不会**删除**之前存在但这次没有设置的字段
- 导致不同单据类型的字段混在一起

---

## ✅ 修复方案

### 修改内容

在 `openEdit` 函数开始时，先调用 `resetFields()` 清空表单：

```typescript
const openEdit = useCallback((receipt: Receipt) => {
  if (!canEditDelete) {
    message.warning('司机无权限编辑票据')
    return
  }
  
  // ✅ 先重置表单，清除之前的所有字段
  editForm.resetFields()
  
  setEditingReceipt(receipt)
  setEditDrawerOpen(true)

  if (receipt.type === 'loading') {
    // 设置装料单字段
    editForm.setFieldsValue({ ... })
  } else if (receipt.type === 'charging') {
    // 设置充电单字段
    editForm.setFieldsValue({ ... })
  } else if (receipt.type === 'departure') {
    // 设置出厂单字段
    editForm.setFieldsValue({ ... })
  }
}, [editForm, canEditDelete, message])
```

### 修复效果

**修复前：**
```
表单状态：
{
  // 充电单字段（残留）
  receipt_number: "CH001",
  charging_station: "国家电网",
  energy_kwh: 50,
  amount: 100,
  
  // 出厂单字段（新设置）
  driver_name: "张三",
  vehicle_no: "京A12345",
  concrete_volume: "10",
  ...
}

提交时：所有字段都会被提交 ❌
```

**修复后：**
```
表单状态：
{
  // 只有出厂单字段
  driver_name: "张三",
  vehicle_no: "京A12345",
  concrete_volume: "10",
  loading_company: "XX公司",
  ...
}

提交时：只提交出厂单字段 ✅
```

---

## 🧪 测试验证

### 测试场景1：充电单 → 出厂单

**步骤：**
1. 打开票据管理，切换到"充电单"标签
2. 点击某条充电单的"编辑"按钮
3. 查看表单字段（应该有充电站、电量等）
4. 关闭编辑抽屉
5. 切换到"出厂单"标签
6. 点击某条出厂单的"编辑"按钮
7. 查看表单字段（应该只有出厂单字段，没有充电站、电量等）
8. 修改某个字段，点击"保存"
9. 应该成功保存，不报错 ✅

### 测试场景2：出厂单 → 充电单

**步骤：**
1. 打开票据管理，切换到"出厂单"标签
2. 点击某条出厂单的"编辑"按钮
3. 查看表单字段（应该有工程名称、方量等）
4. 关闭编辑抽屉
5. 切换到"充电单"标签
6. 点击某条充电单的"编辑"按钮
7. 查看表单字段（应该只有充电单字段，没有工程名称、方量等）
8. 修改某个字段，点击"保存"
9. 应该成功保存，不报错 ✅

### 测试场景3：同类型连续编辑

**步骤：**
1. 打开票据管理，切换到"出厂单"标签
2. 点击第一条出厂单的"编辑"按钮
3. 修改某个字段，点击"保存"
4. 点击第二条出厂单的"编辑"按钮
5. 应该显示第二条出厂单的数据，不是第一条的 ✅
6. 修改某个字段，点击"保存"
7. 应该成功保存，不报错 ✅

---

## 📝 修改文件

### 文件：`src/pages/Receipts.tsx`

**修改位置：** 第 1078 行（`openEdit` 函数）

**修改内容：**
- 在函数开始处添加 `editForm.resetFields()`

**代码行数：**
- 新增：1 行
- 修改：0 行

---

## 🎯 影响范围

### 影响的单据类型

- ✅ 装料单（loading）
- ✅ 卸货单（unloading）
- ✅ 充电单（charging）
- ✅ 水票（water）
- ✅ 出厂单（departure）

### 影响的功能

- ✅ 编辑单据
- ✅ 保存单据
- ❌ 查看单据（不受影响）
- ❌ 删除单据（不受影响）
- ❌ 导出单据（不受影响）

---

## ⚠️ 注意事项

### 1. 表单重置的时机

**正确：** 在打开编辑抽屉时重置
```typescript
const openEdit = (receipt) => {
  editForm.resetFields()  // ✅ 先重置
  setEditDrawerOpen(true)
  editForm.setFieldsValue({ ... })  // 再设置
}
```

**错误：** 在关闭编辑抽屉时重置
```typescript
const closeEdit = () => {
  setEditDrawerOpen(false)
  editForm.resetFields()  // ❌ 太晚了，下次打开时字段已经污染
}
```

### 2. 其他可能的字段污染场景

**场景1：** 不同业务类型的字段
- 罐车有 `tanker_vehicle_code`（自编车号）
- 挂车/侧翻/水泥罐车使用 `user_plate`（用户绑定车牌）
- 需要确保切换业务类型时清除这些特殊字段

**场景2：** 动态字段
- 某些字段可能根据条件显示/隐藏
- 隐藏的字段仍然可能保留在表单状态中
- 提交时需要注意过滤

### 3. 表单验证

重置表单后，验证状态也会被清除：
- ✅ 好处：不会显示之前的验证错误
- ⚠️ 注意：如果需要保留某些验证状态，需要特殊处理

---

## 🔄 类似问题排查

### 其他可能存在的表单污染

1. **创建单据表单**
   - 检查是否在切换单据类型时重置表单
   - 检查是否在打开创建对话框时重置表单

2. **批量编辑表单**
   - 检查是否在切换选中项时重置表单
   - 检查是否在打开批量编辑对话框时重置表单

3. **筛选表单**
   - 检查是否在切换标签页时重置筛选条件
   - 检查是否在重置按钮中清除所有筛选字段

### 排查方法

```typescript
// 在表单提交前打印所有字段
const handleSubmit = () => {
  const values = form.getFieldsValue()
  console.log('表单所有字段：', values)
  console.log('表单字段数量：', Object.keys(values).length)
  
  // 检查是否有不应该存在的字段
  const expectedFields = ['field1', 'field2', 'field3']
  const actualFields = Object.keys(values)
  const unexpectedFields = actualFields.filter(f => !expectedFields.includes(f))
  
  if (unexpectedFields.length > 0) {
    console.warn('发现意外字段：', unexpectedFields)
  }
}
```

---

## 📊 修复前后对比

### 修复前

| 操作 | 表单字段 | 提交字段 | 结果 |
|------|---------|---------|------|
| 编辑充电单 | 充电单字段 | 充电单字段 | ✅ 成功 |
| 编辑出厂单 | 充电单字段 + 出厂单字段 | 充电单字段 + 出厂单字段 | ❌ 失败 |
| 再编辑充电单 | 充电单字段 + 出厂单字段 | 充电单字段 + 出厂单字段 | ❌ 失败 |

### 修复后

| 操作 | 表单字段 | 提交字段 | 结果 |
|------|---------|---------|------|
| 编辑充电单 | 充电单字段 | 充电单字段 | ✅ 成功 |
| 编辑出厂单 | 出厂单字段 | 出厂单字段 | ✅ 成功 |
| 再编辑充电单 | 充电单字段 | 充电单字段 | ✅ 成功 |

---

## 🎉 总结

### 问题根源

**表单字段污染**：不同单据类型的字段混在一起，导致提交时包含不应该存在的字段。

### 解决方案

**在打开编辑抽屉时重置表单**：确保每次编辑都从干净的状态开始。

### 关键改进

1. ✅ 添加 `editForm.resetFields()` 清除表单
2. ✅ 确保每种单据类型只设置自己的字段
3. ✅ 避免字段污染导致的后端错误

### 预期效果

- ✅ 编辑任何单据类型都不会报错
- ✅ 提交的数据只包含当前单据类型的字段
- ✅ 不同单据类型之间互不影响

---

## 📞 技术支持

**问题反馈：** 如有任何问题，请联系技术支持

**文档版本：** v1.0  
**修复时间：** 2026-01-27  
**修复人员：** AI Assistant

---

*本文档详细记录了票据列表表单字段污染问题的分析和修复过程*

