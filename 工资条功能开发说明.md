# 管理后台工资条功能开发说明

## 功能概述

在管理后台的"行政人事"菜单下添加了工资条管理功能，与小程序的工资条功能逻辑完全一致。

## 开发时间

**2025-12-23**

## 新增文件

### 1. 页面组件
**文件**: `src/pages/Salary.tsx`

**功能**:
- 工资条列表展示
- 工资条详情查看
- Excel 批量上传
- 工资周期筛选
- 统计数据展示（总数、应发、扣款、实发）

**主要特性**:
- ✅ 使用 Ant Design 5 组件库
- ✅ React Query 数据管理
- ✅ TypeScript 类型安全
- ✅ 响应式布局
- ✅ 完整的错误处理

### 2. API 服务
**文件**: `src/api/services/salary.ts`

**接口**:
- `fetchSalaryList()` - 获取工资条列表
- `fetchSalaryDetail()` - 获取工资条详情
- `fetchPeriodsList()` - 获取工资周期列表
- `uploadSalaryExcel()` - 上传工资条 Excel

### 3. 路由配置
**文件**: `src/App.tsx`

**修改内容**:
- 导入 `SalaryPage` 组件
- 在"行政人事"菜单下添加"工资条管理"菜单项
- 路由路径: `/salary`
- 图标: `DollarOutlined`

## 功能详情

### 1. 统计卡片
显示四个关键指标：
- **工资条总数**: 当前筛选条件下的工资条数量
- **应发工资总额**: 所有工资条的应发工资总和
- **总扣款**: 所有工资条的扣款总和
- **实发工资总额**: 所有工资条的实发工资总和

### 2. 工资条列表
**列字段**:
- 批次号
- 姓名
- 工资周期
- 应发工资
- 总扣款
- 实发工资（绿色加粗显示）
- 状态（已发送/已读/待发送）
- 发送时间
- 操作（查看详情）

**功能**:
- 工资周期筛选
- 刷新按钮
- 分页显示
- 响应式表格（横向滚动）

### 3. 上传工资条
**上传方式**: Excel 文件上传

**必填信息**:
- 工资周期（月份选择器）
- Excel 文件

**Excel 格式要求**:
- **必须包含**: 姓名、手机号（或用户ID）
- **工资项**: 基本工资、绩效奖金、加班费、津贴、其他收入
- **扣款项**: 社保、公积金、个税、其他扣款
- **自动计算**: 应发工资、总扣款、实发工资

### 4. 工资详情
**详情内容**:
- 基本信息（姓名、工资周期、批次号）
- 收入明细（6项）
- 扣款明细（5项）
- 实发工资（大号显示）
- 其他信息（状态、发送时间、读取时间）

## 后端 API

### 接口列表

#### 1. 上传工资条
```
POST /api/v1/salary/upload
Content-Type: multipart/form-data

参数:
- file: Excel文件
- period: 工资周期 (YYYY-MM)

权限: 财务、总经理
```

#### 2. 获取工资条列表
```
GET /api/v1/salary/list

参数:
- period: 工资周期 (可选)
- page: 页码 (可选)
- page_size: 每页数量 (可选)
```

#### 3. 获取工资条详情
```
GET /api/v1/salary/{salary_id}
```

#### 4. 获取工资周期列表
```
GET /api/v1/salary/periods/list
```

## 数据库表结构

**表名**: `salary_slips`

**主要字段**:
- `id`: 主键
- `batch_no`: 批次号
- `user_id`: 用户ID
- `user_name`: 用户姓名
- `period`: 工资周期
- `base_salary`: 基本工资
- `performance_bonus`: 绩效奖金
- `overtime_pay`: 加班费
- `allowance`: 津贴
- `other_income`: 其他收入
- `total_income`: 应发工资
- `social_security`: 社保
- `housing_fund`: 公积金
- `tax`: 个人所得税
- `other_deduction`: 其他扣款
- `total_deduction`: 总扣款
- `net_salary`: 实发工资
- `details`: 详细信息（JSON）
- `status`: 状态（sent/read/pending）
- `created_by`: 创建人
- `created_at`: 创建时间
- `read_at`: 读取时间

## 权限控制

### 上传权限
- ✅ 财务
- ✅ 总经理
- ❌ 其他角色

### 查看权限
- ✅ 所有登录用户（只能查看自己的工资条）
- ✅ 财务、总经理（可以查看所有人的工资条）

## 使用流程

### 管理员操作流程

1. **准备 Excel 文件**
   - 按照格式要求准备工资条数据
   - 确保包含姓名和手机号

2. **上传工资条**
   - 进入"行政人事" → "工资条管理"
   - 点击"上传工资条"按钮
   - 选择工资周期
   - 选择 Excel 文件
   - 点击确定上传

3. **查看结果**
   - 系统自动解析 Excel
   - 匹配用户信息
   - 创建工资条记录
   - 显示成功/失败统计

4. **管理工资条**
   - 按周期筛选
   - 查看详情
   - 查看统计数据

### 员工查看流程（小程序）

1. 打开小程序
2. 进入"工资条"页面
3. 查看自己的工资条列表
4. 点击查看详情

## 技术栈

### 前端
- **框架**: React 19 + TypeScript
- **UI 库**: Ant Design 5
- **状态管理**: React Query
- **HTTP 客户端**: Axios
- **构建工具**: Vite 7

### 后端
- **框架**: FastAPI
- **ORM**: SQLAlchemy
- **数据库**: MySQL
- **Excel 解析**: pandas + openpyxl

## 注意事项

1. **Excel 格式**
   - 列名可以灵活匹配（支持中英文）
   - 系统会自动识别常见的列名
   - 如果识别失败，会在错误信息中提示

2. **用户匹配**
   - 优先使用 Excel 中的用户ID
   - 其次使用手机号匹配
   - 最后使用姓名模糊匹配
   - 如果都匹配不到，会跳过该行并记录错误

3. **数据计算**
   - 如果 Excel 中提供了总计字段，使用 Excel 的值
   - 如果未提供，系统自动计算
   - 实发工资 = 应发工资 - 总扣款

4. **批次管理**
   - 每次上传生成唯一批次号
   - 格式: `SALARY-YYYYMMDDHHMMSS-随机8位`
   - 便于追溯和管理

## 后续优化建议

1. **导出功能**
   - 支持导出工资条为 Excel
   - 支持批量导出

2. **模板下载**
   - 提供标准 Excel 模板下载
   - 减少格式错误

3. **数据统计**
   - 按部门统计
   - 按月度对比
   - 工资趋势分析

4. **通知功能**
   - 工资条发送后推送通知
   - 提醒员工查看

5. **审批流程**
   - 工资条上传前需要审批
   - 多级审批支持

## 测试建议

### 功能测试
1. ✅ 上传正常格式的 Excel
2. ✅ 上传缺少必填列的 Excel
3. ✅ 上传包含不存在用户的 Excel
4. ✅ 查看工资条列表
5. ✅ 查看工资条详情
6. ✅ 按周期筛选
7. ✅ 统计数据准确性

### 权限测试
1. ✅ 财务角色上传
2. ✅ 总经理角色上传
3. ✅ 普通员工无法上传
4. ✅ 员工只能查看自己的工资条

### 性能测试
1. ✅ 大量数据（1000+条）加载
2. ✅ 大文件（5000+行）上传
3. ✅ 并发上传

## 部署说明

### 前端部署
```bash
cd /Users/niesiyu/Desktop/web-admin
npm run build
# 将 dist 目录部署到服务器
```

### 后端部署
后端 API 已经存在，无需额外部署。

### 数据库
确保 `salary_slips` 表已创建（使用 `create_salary_tables.sql`）

---

**开发完成时间**: 2025-12-23  
**开发人员**: Cascade AI Assistant  
**版本**: v1.0.0
