# 前端集成企业微信登录说明

## 已完成的工作

1. ✅ 创建了企业微信回调页面 `src/pages/WorkWechatCallback.tsx`
2. ⏳ 需要在登录页面添加"企业微信登录"按钮
3. ⏳ 需要添加路由配置

## 步骤1：添加路由

在路由配置文件中添加回调页面路由（通常是 `src/App.tsx` 或 `src/router/index.tsx`）：

```tsx
import WorkWechatCallback from './pages/WorkWechatCallback';

// 在路由配置中添加
{
  path: '/work-wechat-callback',
  element: <WorkWechatCallback />
}
```

## 步骤2：在登录页面添加企业微信登录按钮

找到登录页面文件（通常是 `src/pages/Login.tsx` 或类似文件），添加以下代码：

### 方法1：添加完整的企业微信登录功能

```tsx
import { Button, message } from 'antd';
import { WechatOutlined } from '@ant-design/icons';

// 在登录页面组件中添加
const handleWorkWechatLogin = async () => {
  try {
    // 1. 获取授权URL
    const redirectUri = encodeURIComponent(
      `${window.location.origin}/work-wechat-callback`
    );
    
    const response = await fetch(
      `https://api.hodaruner.cn/api/v1/work-wechat-auth/get-auth-url?redirect_uri=${redirectUri}`
    );
    const result = await response.json();
    
    if (result.success) {
      // 2. 跳转到企业微信授权页面
      window.location.href = result.data.auth_url;
    } else {
      message.error('获取授权URL失败');
    }
  } catch (error) {
    console.error('获取授权URL失败:', error);
    message.error('网络错误，请重试');
  }
};

// 在登录表单下方添加按钮
<Button
  type="default"
  icon={<WechatOutlined />}
  onClick={handleWorkWechatLogin}
  block
  style={{ marginTop: 16 }}
>
  企业微信登录
</Button>
```

### 方法2：简化版（如果登录页面已有类似结构）

```tsx
// 添加企业微信登录按钮
<Button
  type="default"
  icon={<WechatOutlined />}
  onClick={async () => {
    const redirectUri = encodeURIComponent(`${window.location.origin}/work-wechat-callback`);
    const response = await fetch(
      `https://api.hodaruner.cn/api/v1/work-wechat-auth/get-auth-url?redirect_uri=${redirectUri}`
    );
    const result = await response.json();
    if (result.success) {
      window.location.href = result.data.auth_url;
    }
  }}
  block
  style={{ marginTop: 16 }}
>
  企业微信登录
</Button>
```

## 步骤3：样式调整（可选）

如果需要调整按钮样式，可以添加自定义样式：

```tsx
<Button
  type="default"
  icon={<WechatOutlined style={{ color: '#07C160' }} />}
  onClick={handleWorkWechatLogin}
  block
  style={{ 
    marginTop: 16,
    borderColor: '#07C160',
    color: '#07C160'
  }}
>
  企业微信登录
</Button>
```

## 完整示例

假设你的登录页面结构如下：

```tsx
import { Form, Input, Button, message } from 'antd';
import { UserOutlined, LockOutlined, WechatOutlined } from '@ant-design/icons';
import useAuthStore from '../store/auth';

function Login() {
  const setAuth = useAuthStore((state) => state.setAuth);

  const onFinish = async (values: any) => {
    // 原有的登录逻辑
    // ...
  };

  const handleWorkWechatLogin = async () => {
    try {
      const redirectUri = encodeURIComponent(
        `${window.location.origin}/work-wechat-callback`
      );
      
      const response = await fetch(
        `https://api.hodaruner.cn/api/v1/work-wechat-auth/get-auth-url?redirect_uri=${redirectUri}`
      );
      const result = await response.json();
      
      if (result.success) {
        window.location.href = result.data.auth_url;
      } else {
        message.error('获取授权URL失败');
      }
    } catch (error) {
      console.error('获取授权URL失败:', error);
      message.error('网络错误，请重试');
    }
  };

  return (
    <div className="login-container">
      <Form onFinish={onFinish}>
        <Form.Item name="username" rules={[{ required: true }]}>
          <Input prefix={<UserOutlined />} placeholder="用户名" />
        </Form.Item>
        
        <Form.Item name="password" rules={[{ required: true }]}>
          <Input.Password prefix={<LockOutlined />} placeholder="密码" />
        </Form.Item>
        
        <Form.Item>
          <Button type="primary" htmlType="submit" block>
            登录
          </Button>
        </Form.Item>
        
        {/* 企业微信登录按钮 */}
        <Form.Item>
          <Button
            type="default"
            icon={<WechatOutlined />}
            onClick={handleWorkWechatLogin}
            block
          >
            企业微信登录
          </Button>
        </Form.Item>
      </Form>
    </div>
  );
}

export default Login;
```

## 测试步骤

1. **启动前端开发服务器**
   ```bash
   cd /Users/niesiyu/Desktop/web-admin
   npm run dev
   ```

2. **访问登录页面**
   - 打开浏览器访问 `http://localhost:5173/login`（或你的开发服务器地址）

3. **点击"企业微信登录"按钮**
   - 应该会跳转到企业微信授权页面
   - 扫码授权后会回调到 `/work-wechat-callback`
   - 自动登录并跳转到首页

## 注意事项

1. **回调域名配置**
   - 开发环境：`localhost:5173` 或 `127.0.0.1:5173`
   - 生产环境：`admin.hodaruner.cn`
   - 需要在企业微信后台配置对应的回调域名

2. **用户必须先绑定企业微信**
   - 如果用户未绑定企业微信UserID，登录会失败
   - 提示用户先在小程序中绑定

3. **HTTPS要求**
   - 生产环境必须使用HTTPS
   - 开发环境可以使用HTTP

## 常见问题

### Q1: 点击按钮后没有反应？
A: 检查浏览器控制台是否有错误，确认API地址是否正确。

### Q2: 跳转后提示"redirect_uri参数错误"？
A: 检查企业微信后台是否配置了正确的回调域名。

### Q3: 授权后提示"用户未绑定"？
A: 用户需要先在小程序中绑定企业微信UserID。
