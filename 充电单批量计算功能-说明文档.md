# 充电单批量计算功能 - 说明文档

## 📋 功能概述

在充电单列表页面新增了**批量计算金额**功能，支持：

- ✅ 多选充电单进行批量计算
- ✅ 显示每条记录的计算单价和生效日期
- ✅ 自动使用正确生效日期的电价规则
- ✅ 选择性应用计算结果
- ✅ 实时显示计算进度和结果

---

## 🎯 使用场景

### 场景1：批量处理历史充电单
当有大量历史充电单需要计算金额时，可以：
1. 筛选出需要计算的充电单
2. 全选或多选
3. 点击"批量计算金额"
4. 查看计算结果并选择性应用

### 场景2：验证计算准确性
对于已有计算结果的充电单，可以：
1. 重新批量计算
2. 对比新旧计算结果
3. 确认电价规则是否正确

### 场景3：修正错误数据
当发现某些充电单的计算金额不准确时：
1. 选中这些充电单
2. 批量重新计算
3. 应用正确的计算结果

---

## 🚀 功能特性

### 1. 智能选择

**多种选择方式：**
- 手动勾选单条或多条
- 全选所有数据
- 选择当前页
- 反选当前页
- 清空所有选择

**选择提示：**
- 实时显示已选择的记录数量
- 选择后显示操作按钮

### 2. 批量计算

**计算前验证：**
- 自动检查充电单信息完整性
- 必须有充电站信息
- 必须有充电时间
- 必须有有效的电量信息

**智能跳过：**
- 信息不完整的充电单自动跳过
- 显示跳过原因
- 询问是否继续计算其他充电单

**实时进度：**
- 显示当前计算进度（如：正在计算 5/20...）
- 计算完成后显示成功/失败统计

### 3. 结果展示

**详细的计算结果表格：**

| 列名 | 说明 |
|------|------|
| 选择 | 勾选框，选择要应用的结果 |
| 状态 | 成功/失败标签 |
| 单据编号 | 充电单编号 |
| 车牌号 | 车辆信息 |
| 充电站 | 充电站名称 |
| 充电时间 | 充电开始时间 |
| 电量(kWh) | 充电电量 |
| 识别金额 | OCR识别的金额 |
| 计算金额 | 系统计算的金额（金色高亮） |
| 计算单价 | 单价 + 生效日期（绿色高亮） |
| 金额差异 | 识别金额 - 计算金额 |
| 错误信息 | 失败原因 |

**计算单价显示：**
```
¥1.2320/kWh
生效日期: 2026-01-15
```

**金额差异颜色：**
- 🔴 红色：识别金额 > 计算金额（正差异）
- 🟢 绿色：识别金额 < 计算金额（负差异）
- ⚫ 黑色：无差异

### 4. 选择性应用

**灵活的结果选择：**
- 默认选中所有成功的计算结果
- 可以取消勾选不想应用的结果
- 失败的结果无法勾选
- 显示已选择的数量

**批量操作：**
- "全选成功项"：选中所有计算成功的结果
- "取消全选"：取消所有选择

**应用确认：**
- 显示将要应用的数量
- 二次确认避免误操作
- 显示应用进度
- 应用完成后自动刷新列表

---

## 📖 使用步骤

### 步骤1：选择充电单

1. 打开充电单列表页面
2. 使用筛选条件缩小范围（可选）
3. 勾选需要计算的充电单

**快捷选择：**
```
点击表格左上角的下拉菜单：
- 全选所有数据
- 选择当前页
- 反选当前页
- 清空所有选择
```

### 步骤2：执行批量计算

1. 点击顶部的 **"批量计算金额"** 按钮
2. 如果有信息不完整的充电单，系统会提示：
   - 显示不完整的充电单列表
   - 询问是否继续计算其他充电单
3. 等待计算完成（显示实时进度）

### 步骤3：查看计算结果

计算完成后，会弹出结果对话框：

**顶部统计：**
```
成功计算 18 条，失败 2 条
请勾选要应用的计算结果，点击下方按钮批量更新充电单数据
```

**结果表格：**
- 查看每条充电单的计算结果
- 查看计算单价和生效日期
- 查看金额差异
- 查看失败原因（如果有）

### 步骤4：选择要应用的结果

1. 默认已选中所有成功的结果
2. 可以取消勾选不想应用的结果
3. 使用"全选成功项"/"取消全选"快速操作

### 步骤5：应用计算结果

1. 点击底部的 **"应用选中的计算结果 (N)"** 按钮
2. 确认应用操作
3. 等待应用完成
4. 查看成功/失败统计
5. 列表自动刷新，显示更新后的数据

---

## 💡 使用技巧

### 技巧1：分批处理大量数据

如果有数百条充电单需要计算：

1. **使用筛选条件分批处理**
   ```
   例如：按日期范围分批
   - 第1批：2026-01-01 ~ 2026-01-10
   - 第2批：2026-01-11 ~ 2026-01-20
   - 第3批：2026-01-21 ~ 2026-01-31
   ```

2. **每批处理20-50条**
   - 避免一次处理过多导致等待时间过长
   - 便于检查和验证结果

### 技巧2：验证计算准确性

对于重要的充电单，建议：

1. **先单独计算一条**
   - 点击单条记录的"计算金额"按钮
   - 查看详细的电价表和计算过程
   - 确认计算逻辑正确

2. **再批量计算同类充电单**
   - 选择同一充电站的充电单
   - 批量计算
   - 对比结果是否一致

### 技巧3：处理失败的充电单

如果有充电单计算失败：

1. **查看失败原因**
   - 在结果表格的"错误信息"列查看
   - 常见原因：
     - 充电站未配置电价规则
     - 充电站名称不匹配
     - 充电时间超出电价规则有效期

2. **修正数据后重新计算**
   - 在列表中编辑充电单
   - 补充或修正信息
   - 重新选择并计算

### 技巧4：对比新旧计算结果

如果充电单已有计算金额，想要重新计算：

1. **导出当前数据作为备份**
   - 点击"导出选中"保存当前数据

2. **执行批量计算**
   - 查看新的计算结果

3. **对比差异**
   - 在结果表格中查看金额差异
   - 如果差异较大，检查电价规则是否有变化

---

## ⚠️ 注意事项

### 1. 计算条件

充电单必须满足以下条件才能计算：

- ✅ **充电站信息不为空**
  - 必须有充电站名称
  - 充电站名称能匹配到数据库中的充电站

- ✅ **充电时间不为空**
  - 必须有充电开始时间
  - 用于匹配正确的时段电价

- ✅ **电量信息有效**
  - 电量必须大于0
  - 用于计算总金额

### 2. 电价规则

计算使用的电价规则：

- 📅 **根据充电时间自动匹配**
  - 系统会查找充电时间点生效的电价规则
  - 如果有多个规则，按优先级选择

- 🕐 **时段电价**
  - 支持不同时段不同单价
  - 例如：峰时、平时、谷时

- 📆 **生效日期**
  - 电价规则有生效日期和失效日期
  - 只使用在充电时间范围内生效的规则

### 3. 数据更新

应用计算结果后：

- ✅ **更新字段**
  - `calculated_amount`：计算金额
  - `calculated_unit_price`：计算单价

- ⚠️ **不更新字段**
  - `amount`：识别金额（保持不变）
  - 其他字段保持不变

- 🔄 **自动刷新**
  - 应用成功后列表自动刷新
  - 显示最新的计算结果

### 4. 性能考虑

- ⏱️ **计算时间**
  - 每条充电单约需0.5-1秒
  - 20条约需10-20秒
  - 100条约需50-100秒

- 💡 **建议**
  - 单次批量计算不超过100条
  - 大量数据分批处理
  - 避免在高峰期执行大批量计算

---

## 🔧 常见问题

### Q1: 为什么有些充电单无法计算？

**A:** 可能的原因：

1. **充电站信息缺失**
   - 解决：编辑充电单，补充充电站名称

2. **充电站未配置电价规则**
   - 解决：前往"充电站管理"页面配置电价规则

3. **充电站名称不匹配**
   - 解决：检查充电站名称是否与数据库中的一致
   - 或者在充电站管理中添加别名

4. **充电时间超出电价规则有效期**
   - 解决：为该充电站添加覆盖该时间段的电价规则

### Q2: 计算结果与实际金额差异很大怎么办？

**A:** 检查以下几点：

1. **电价规则是否正确**
   - 前往"充电站管理"查看电价规则
   - 确认单价、时段、生效日期是否正确

2. **充电站是否匹配正确**
   - 检查充电单的充电站名称
   - 确认是否匹配到了正确的充电站

3. **充电时间是否准确**
   - 检查充电开始时间
   - 确认是否在正确的时段

4. **识别金额是否准确**
   - OCR识别可能有误
   - 以实际票据为准

### Q3: 批量计算失败了怎么办？

**A:** 处理步骤：

1. **查看错误信息**
   - 在结果对话框中查看失败原因

2. **修正数据**
   - 根据错误信息修正充电单数据

3. **重新计算**
   - 重新选择失败的充电单
   - 再次执行批量计算

4. **联系管理员**
   - 如果问题持续，联系系统管理员
   - 提供充电单ID和错误信息

### Q4: 可以撤销已应用的计算结果吗？

**A:** 可以，有两种方式：

1. **手动编辑**
   - 在列表中点击"编辑"
   - 修改计算金额和计算单价
   - 或者清空这两个字段

2. **重新计算**
   - 选择该充电单
   - 重新执行批量计算
   - 应用新的计算结果

### Q5: 批量计算会影响识别金额吗？

**A:** 不会！

- ✅ 批量计算只更新 `calculated_amount` 和 `calculated_unit_price`
- ✅ `amount`（识别金额）字段保持不变
- ✅ 可以随时对比识别金额和计算金额的差异

---

## 📊 功能截图说明

### 1. 选择充电单

```
┌─────────────────────────────────────────────────────┐
│ 已选择 15 条记录                                     │
│ [批量计算金额] [导出选中] [清空选择]                 │
└─────────────────────────────────────────────────────┘
```

### 2. 计算进度

```
正在计算 8/15...
```

### 3. 计算结果对话框

```
┌─────────────────────────────────────────────────────┐
│ 批量计算结果 (15 条)                          [X]    │
├─────────────────────────────────────────────────────┤
│ ℹ️ 成功计算 13 条，失败 2 条                         │
│   请勾选要应用的计算结果，点击下方按钮批量更新       │
│                                                      │
│ [全选成功项] [取消全选]                              │
│                                                      │
│ ┌──┬────┬────────┬────────┬──────────┬─────┐      │
│ │☑│成功│单据编号│车牌号  │充电站    │...  │      │
│ ├──┼────┼────────┼────────┼──────────┼─────┤      │
│ │☑│成功│6101... │陕A21096│中建西部..│...  │      │
│ │☑│成功│6101... │陕A27861│秦汉恒盛  │...  │      │
│ │☐│失败│6101... │陕A26991│         │...  │      │
│ └──┴────┴────────┴────────┴──────────┴─────┘      │
│                                                      │
│              [取消] [应用选中的计算结果 (13)]        │
└─────────────────────────────────────────────────────┘
```

### 4. 计算单价显示

```
¥1.2320/kWh
生效日期: 2026-01-15
```

---

## 🎉 功能优势

### 1. 效率提升

- ⚡ **批量处理**：一次处理多条充电单，节省时间
- 🚀 **自动计算**：无需手动计算，减少人工错误
- 📊 **实时反馈**：即时显示计算结果和进度

### 2. 准确性保证

- 🎯 **精确匹配**：根据充电时间自动匹配正确的电价规则
- 📅 **生效日期**：显示电价规则的生效日期，确保使用正确的单价
- 🔍 **差异对比**：自动计算并显示金额差异，便于核对

### 3. 灵活性

- ✅ **选择性应用**：可以选择性地应用计算结果
- 🔄 **可重复计算**：可以多次计算，对比结果
- 📝 **保留原数据**：识别金额不会被覆盖

### 4. 用户友好

- 🎨 **直观的界面**：清晰的表格展示，颜色区分
- 💡 **智能提示**：自动检查数据完整性，提示问题
- 📖 **详细信息**：显示单价、生效日期、差异等详细信息

---

## 🔄 更新日志

### v1.0 (2026-01-26)

**新增功能：**
- ✅ 批量计算金额功能
- ✅ 显示计算单价和生效日期
- ✅ 选择性应用计算结果
- ✅ 实时计算进度显示
- ✅ 详细的结果表格
- ✅ 智能数据验证

**优化改进：**
- ✅ 自动跳过信息不完整的充电单
- ✅ 显示失败原因
- ✅ 支持全选/取消全选
- ✅ 应用后自动刷新列表

---

## 📞 技术支持

如有问题或建议，请联系：

- 📧 技术支持邮箱：support@example.com
- 💬 在线客服：系统右下角聊天图标
- 📱 技术支持电话：400-xxx-xxxx

---

*充电单批量计算功能说明文档 v1.0*  
*最后更新：2026-01-26*

