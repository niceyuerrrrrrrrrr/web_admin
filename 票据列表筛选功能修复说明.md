# 票据列表筛选功能修复说明

## 修复日期
2026-01-26

## 问题描述

### 1. 分页统计问题
**问题**：当用户使用列筛选功能筛选数据后，底部的分页条数和页数仍然显示全部数据的数量，而不是筛选后的数据数量。

**影响**：用户无法准确了解筛选后的数据量，分页导航也不准确。

### 2. 全选功能问题
**问题**：当用户筛选数据后，点击"全选"按钮会选中所有原始数据，而不是只选中筛选后的数据。

**影响**：用户可能误操作选中了不可见的数据，导致批量操作（如批量删除、批量导出）作用于错误的数据范围。

### 3. 筛选逻辑混乱
**问题**：多个筛选条件（顶部筛选、列筛选、方量筛选等）之间的关系不清晰，数据状态管理混乱。

## 修复方案

### 核心改进：引入 `currentDisplayData` 统一数据源

创建了一个统一的计算属性 `currentDisplayData`，它会根据以下优先级返回当前应该显示的数据：

1. **列筛选数据**（最高优先级）：如果用户使用了表格列的筛选功能，使用 `tableFilteredData`
2. **顶部筛选数据**：如果没有列筛选，使用经过顶部筛选条件（日期、车牌号、删除状态、交票状态、方量筛选等）过滤后的数据

```typescript
const currentDisplayData = useMemo(() => {
  // 如果有表格筛选数据（列筛选），使用筛选后的数据
  if (tableFilteredData.length > 0) {
    return tableFilteredData
  }
  // 否则使用原始数据（已经包含了方量筛选等顶部筛选条件）
  return activeTab === 'matched' ? matchedReceipts : filteredReceipts
}, [tableFilteredData, activeTab, matchedReceipts, filteredReceipts])
```

### 具体修复内容

#### 1. 修复分页统计
**修改位置**：Table 组件的 pagination 配置

**修改前**：
```typescript
pagination={{
  total: tableFilteredData.length > 0 ? tableFilteredData.length : (activeTab === 'matched' ? matchedReceipts.length : filteredReceipts.length),
  // ...
}}
```

**修改后**：
```typescript
pagination={{
  total: currentDisplayData.length,
  // ...
}}
```

**效果**：分页总数现在会准确反映当前筛选后的数据量。

#### 2. 修复全选功能
**修改位置**：
- "全选筛选结果"按钮
- 表头下拉菜单的"全部选中"选项
- 表头复选框的 `onSelectAll` 回调
- 自定义复选框的 `onChange` 事件

**修改前**：使用 `tableFilteredData.length > 0 ? tableFilteredData : originalData`

**修改后**：统一使用 `currentDisplayData`

**效果**：
- 点击"全选筛选结果"按钮时，只会选中当前筛选后可见的数据
- 按钮文本显示准确的筛选结果数量
- 取消全选按钮也会显示当前已选中的数量

#### 3. 优化筛选逻辑
**新增状态**：
```typescript
const [sortedInfo, setSortedInfo] = useState<any>({})
```

**改进 onChange 处理**：
```typescript
onChange={(_pagination, filters, sorter, extra) => {
  // 更新筛选信息
  setFilteredInfo(filters || {})
  
  // 更新排序信息
  setSortedInfo(sorter || {})
  
  // 更新筛选后的数据（用于分页统计和全选）
  if (extra.action === 'filter') {
    setTableFilteredData(extra.currentDataSource || [])
    setCurrentPage(1) // 筛选后重置到第一页
    setSelectedRowKeys([]) // 筛选后清空选择
  } else if (extra.action === 'sort') {
    // 排序时也更新数据源
    setTableFilteredData(extra.currentDataSource || [])
  }
}}
```

**切换标签页时重置状态**：
```typescript
useEffect(() => {
  setSelectedRowKeys([])
  setCurrentPage(1)
  setTableFilteredData([]) // 重置筛选数据
  setFilteredInfo({}) // 重置筛选条件
  setSortedInfo({}) // 重置排序信息
}, [activeTab])
```

#### 4. 改进用户体验
**按钮文本优化**：
- "全选所有" → "全选筛选结果"，更清晰地表明是选中筛选后的数据
- 显示具体的数据条数，如 "全选筛选结果 (25)"
- "取消全选" 按钮显示已选中的数量，如 "取消全选 (10)"

**筛选后自动清空选择**：
- 当用户进行列筛选时，自动清空之前的选择，避免选中不可见的数据

## 筛选逻辑层次结构

```
原始数据 (receipts / matchedReceipts)
    ↓
顶部筛选（日期、车牌号、删除状态、交票状态、方量筛选等）
    ↓
filteredReceipts
    ↓
列筛选（表格列的筛选器）
    ↓
tableFilteredData
    ↓
currentDisplayData（统一的显示数据源）
    ↓
分页显示
```

## 测试建议

### 测试场景 1：列筛选 + 分页
1. 进入票据列表页面
2. 点击某一列的筛选器（如"司机"列），选择一个或多个值
3. 观察底部分页信息，应该显示筛选后的数据量
4. 翻页查看，应该只显示筛选后的数据

### 测试场景 2：列筛选 + 全选
1. 进入票据列表页面
2. 点击某一列的筛选器，筛选出部分数据（如筛选出 15 条）
3. 点击"全选筛选结果"按钮
4. 应该只选中这 15 条数据，按钮应显示 "全选筛选结果 (15)"
5. 点击"批量导出"或"批量删除"，应该只操作这 15 条数据

### 测试场景 3：多重筛选
1. 先使用顶部筛选（如选择日期范围、删除状态）
2. 再使用列筛选（如筛选特定司机）
3. 观察数据应该同时满足两个筛选条件
4. 分页和全选功能应该基于最终筛选结果

### 测试场景 4：切换标签页
1. 在某个标签页进行筛选和选择
2. 切换到另一个标签页
3. 筛选条件和选择状态应该被重置
4. 再切换回原标签页，筛选条件应该保持（因为是通过顶部筛选表单控制的）

### 测试场景 5：方量筛选（仅出厂单）
1. 切换到"出厂单"标签页
2. 在顶部筛选中选择"小方量(<9.1)"
3. 应该只显示方量小于 9.1 的出厂单
4. 分页和全选应该基于筛选后的数据

## 注意事项

1. **数据一致性**：所有涉及数据操作的地方（全选、分页、导出等）都应该使用 `currentDisplayData`
2. **状态同步**：筛选、排序、分页状态需要保持同步
3. **用户反馈**：操作后应该有明确的提示信息，告知用户操作的数据范围
4. **性能考虑**：`currentDisplayData` 使用 `useMemo` 进行缓存，避免不必要的重新计算

## 相关文件

- `/Users/niesiyu/Desktop/web-admin/src/pages/Receipts.tsx` - 主要修改文件

## 后续优化建议

1. **筛选条件显示**：在页面上显示当前生效的筛选条件，让用户清楚了解数据范围
2. **筛选历史**：保存用户的筛选偏好，下次访问时自动应用
3. **高级筛选**：提供更复杂的筛选组合功能
4. **导出筛选结果**：在导出时明确提示导出的是筛选后的数据还是全部数据

