# 充电单计算功能 - 部署清单

## 📋 部署概述

**功能名称：** 充电单列表计算功能  
**版本：** v1.0.0  
**部署日期：** 2026-01-26  
**影响范围：** 前端 - 充电单列表页面

---

## ✅ 部署前检查

### 1. 代码检查
- [x] ChargingList.tsx 文件已创建
- [x] TypeScript 编译通过
- [x] 构建成功（npm run build）
- [x] 无 ESLint 错误
- [x] 无 TypeScript 类型错误

### 2. 依赖检查
确保以下依赖已安装：
- [x] antd (UI组件库)
- [x] @ant-design/icons (图标库)
- [x] @tanstack/react-query (数据请求)
- [x] dayjs (日期处理)
- [x] xlsx (Excel导出)

### 3. API检查
确保后端API已部署：
- [ ] `POST /charging-pricing/calculate` - 计算充电费用
- [ ] `PUT /receipts/charging/{id}` - 更新充电单
- [ ] `GET /receipts` - 获取充电单列表
- [ ] `GET /receipts/charging/filter-options` - 获取筛选选项

### 4. 数据库检查
确保数据库表包含以下字段：
- [ ] `charging_receipts.calculated_amount` - 计算金额
- [ ] `charging_receipts.calculated_unit_price` - 计算单价
- [ ] `charging_receipts.charging_station` - 充电站名称
- [ ] `charging_receipts.start_time` - 充电开始时间
- [ ] `charging_receipts.energy_kwh` - 充电电量

---

## 📦 部署文件清单

### 新增文件
```
web-admin/
├── src/
│   └── pages/
│       └── ChargingList.tsx (新增，891行)
└── 充电单计算功能说明.md (文档)
└── 充电单计算功能-测试指南.md (文档)
└── 充电单计算功能-部署清单.md (本文件)
```

### 修改文件
```
无需修改其他文件
```

---

## 🚀 部署步骤

### 步骤1：备份现有代码
```bash
# 备份当前版本
cd /Users/niesiyu/Desktop/web-admin
git add .
git commit -m "backup: 充电单计算功能部署前备份"
```

### 步骤2：验证构建
```bash
# 清理并重新构建
cd /Users/niesiyu/Desktop/web-admin
rm -rf dist node_modules/.vite
npm run build
```

**预期结果：**
- ✅ 构建成功
- ✅ 无错误和警告
- ✅ dist 目录生成

### 步骤3：本地测试
```bash
# 启动开发服务器
npm run dev
```

**测试项目：**
1. 访问 http://localhost:5173/charging/list
2. 验证页面正常加载
3. 测试"计算金额"按钮功能
4. 验证计算流程完整性

### 步骤4：部署到生产环境
```bash
# 方式1：直接部署构建产物
cd /Users/niesiyu/Desktop/web-admin
npm run build
# 将 dist 目录上传到服务器

# 方式2：通过Git部署
git add .
git commit -m "feat: 添加充电单计算功能"
git push origin master
# 在服务器上拉取代码并构建
```

### 步骤5：验证部署
访问生产环境：
- [ ] 页面正常加载
- [ ] 计算功能正常工作
- [ ] 数据正确保存
- [ ] 无控制台错误

---

## 🔧 配置说明

### 环境变量
无需额外配置环境变量

### API配置
确保 `src/api/client.ts` 中的 baseURL 正确配置：
```typescript
const client = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 30000,
})
```

---

## 📊 功能特性

### 新增功能
1. ✅ 充电单列表操作列新增"计算金额"按钮
2. ✅ 计算前显示充电站和电价表信息
3. ✅ 计算后显示详细结果和对比信息
4. ✅ 支持应用计算结果更新充电单
5. ✅ 完整的错误处理和用户提示

### 保留功能
- ✅ 列表查询和筛选
- ✅ 数据导出（全部/选中）
- ✅ 查看和编辑功能
- ✅ 列配置功能
- ✅ 分页和排序

---

## ⚠️ 注意事项

### 1. 数据完整性
- 计算功能依赖充电站、时间、电量数据
- 建议在数据录入时确保这些字段完整

### 2. 电价规则配置
- 计算依赖充电站管理中的时段电价规则
- 部署前确保主要充电站已配置电价规则
- 电价规则需要设置正确的生效日期

### 3. 权限控制
- 计算功能继承充电单列表的编辑权限
- 司机角色可能无法使用此功能（根据现有权限配置）

### 4. 性能考虑
- 计算API调用有30秒超时限制
- 建议优化后端计算逻辑，确保响应时间 < 2秒

### 5. 用户培训
- 建议对使用人员进行功能培训
- 说明计算逻辑和应用场景
- 强调原识别金额不会被修改

---

## 🐛 已知问题

### 问题1：电价规则查询
**描述：** 当前版本在计算对话框中不直接显示具体的电价规则列表  
**影响：** 用户无法在计算前看到具体的电价  
**解决方案：** 后续版本可以添加电价规则详情展示  
**优先级：** 低

### 问题2：批量计算
**描述：** 当前版本不支持批量计算多条充电单  
**影响：** 需要逐条计算  
**解决方案：** 后续版本可以添加批量计算功能  
**优先级：** 中

---

## 📈 监控指标

### 性能指标
- 计算API响应时间 < 2秒
- 页面加载时间 < 3秒
- 列表刷新时间 < 1秒

### 业务指标
- 计算功能使用率
- 计算成功率
- 金额差异分布

### 错误监控
- API调用失败率
- 前端错误日志
- 用户反馈问题

---

## 🔄 回滚方案

如果部署后出现严重问题，可以快速回滚：

### 方式1：Git回滚
```bash
# 回滚到上一个版本
git revert HEAD
git push origin master
# 重新构建和部署
```

### 方式2：文件替换
```bash
# 使用备份的 ChargingList.tsx
# 如果之前是空文件，可以直接删除内容
echo "" > src/pages/ChargingList.tsx
# 重新构建
npm run build
```

### 方式3：功能禁用
在 `App.tsx` 中临时注释掉充电单列表路由：
```typescript
// {
//   key: 'charging-list',
//   label: '充电单列表',
//   path: '/charging/list',
//   element: <ChargingList />,
// },
```

---

## 📞 支持联系

**开发负责人：** AI Assistant  
**部署负责人：** ___________  
**测试负责人：** ___________  

**紧急联系：**
- 技术支持：___________
- 业务支持：___________

---

## ✍️ 部署记录

| 日期 | 版本 | 操作人 | 环境 | 状态 | 备注 |
|------|------|--------|------|------|------|
| 2026-01-26 | v1.0.0 | - | 开发 | ✅ 完成 | 初始版本 |
| - | - | - | 测试 | ⏳ 待部署 | - |
| - | - | - | 生产 | ⏳ 待部署 | - |

---

## 📝 部署签字确认

**开发确认：** ___________  日期：___________  
**测试确认：** ___________  日期：___________  
**部署确认：** ___________  日期：___________  
**验收确认：** ___________  日期：___________

---

## 🎉 部署完成

- [ ] 代码已部署
- [ ] 功能已测试
- [ ] 文档已更新
- [ ] 用户已培训
- [ ] 监控已配置

**部署状态：** ⏳ 进行中

---

*本文档由 AI Assistant 自动生成，最后更新时间：2026-01-26*

