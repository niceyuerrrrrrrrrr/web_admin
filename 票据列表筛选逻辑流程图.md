# 票据列表筛选逻辑流程图

## 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                         原始数据源                                │
│                                                                 │
│  receiptsQuery.data.receipts (装料单/卸货单/充电单/水票/出厂单)    │
│  matchedReceiptsQuery.data.receipts (装卸匹配)                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    第一层：顶部筛选条件                            │
│                                                                 │
│  • 日期范围 (dateRange)                                          │
│  • 车牌号 (vehicleNo)                                            │
│  • 车号 (tankerVehicleCode)                                      │
│  • 删除状态 (deletedStatus: all/normal/deleted)                  │
│  • 交票状态 (submittedStatus: all/submitted/not_submitted)       │
│  • 方量筛选 (volumeFilter: all/small/normal) - 仅出厂单           │
│  • 部门筛选 (selectedDepartmentId)                               │
│  • 用户筛选 (selectedUserId)                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    filteredReceipts                             │
│                 (经过顶部筛选后的数据)                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    第二层：列筛选条件                              │
│                                                                 │
│  • 司机筛选 (driver_name)                                        │
│  • 公司筛选 (company)                                            │
│  • 材料名称筛选 (material_name)                                  │
│  • 规格型号筛选 (material_spec)                                  │
│  • 车牌号筛选 (vehicle_no/user_plate)                            │
│  • 充电站筛选 (charging_station)                                 │
│  • 交票状态筛选 (submitted_to_finance)                           │
│  • ... 其他列筛选                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    tableFilteredData                            │
│              (经过列筛选后的数据，可能为空)                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  currentDisplayData (核心)                       │
│                                                                 │
│  逻辑：                                                           │
│  if (tableFilteredData.length > 0) {                            │
│    return tableFilteredData  // 有列筛选，使用列筛选结果           │
│  } else {                                                       │
│    return filteredReceipts   // 无列筛选，使用顶部筛选结果         │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│  Table组件    │    │  分页统计     │      │  全选功能     │
│              │    │              │      │              │
│ dataSource=  │    │ total=       │      │ 选中范围=     │
│ currentDis-  │    │ currentDis-  │      │ currentDis-  │
│ playData     │    │ playData.    │      │ playData     │
│              │    │ length       │      │              │
└──────────────┘    └──────────────┘      └──────────────┘
```

## 修复前后对比

### 修复前 ❌

```
用户操作：列筛选（筛选出25条数据）

分页显示：共 100 条  ← 错误！显示的是原始数据量
全选按钮：全选所有 (100)  ← 错误！会选中所有数据
点击全选：选中 100 条  ← 错误！包含不可见的数据

问题：用户看到25条数据，但操作的是100条数据
```

### 修复后 ✅

```
用户操作：列筛选（筛选出25条数据）

分页显示：共 25 条  ← 正确！显示筛选后的数量
全选按钮：全选筛选结果 (25)  ← 正确！明确是筛选结果
点击全选：选中 25 条  ← 正确！只选中可见数据

结果：用户看到什么，操作的就是什么
```

## 关键代码位置

### 1. 统一数据源定义
```typescript
// 文件：Receipts.tsx
// 位置：约第 380 行

const currentDisplayData = useMemo(() => {
  if (tableFilteredData.length > 0) {
    return tableFilteredData
  }
  return activeTab === 'matched' ? matchedReceipts : filteredReceipts
}, [tableFilteredData, activeTab, matchedReceipts, filteredReceipts])
```

### 2. 分页配置
```typescript
// 文件：Receipts.tsx
// 位置：约第 4380 行

pagination={{
  current: currentPage,
  total: currentDisplayData.length,  // ← 关键修改
  pageSize: pageSize,
  showTotal: (total) => `共 ${total} 条`,
  // ...
}}
```

### 3. 全选按钮
```typescript
// 文件：Receipts.tsx
// 位置：约第 4180 行

<Button
  onClick={() => {
    const allKeys = currentDisplayData.map((record: any) => {
      // 生成选择键
    })
    setSelectedRowKeys(allKeys)
    message.success(`已全选 ${allKeys.length} 条筛选数据`)
  }}
>
  全选筛选结果 ({currentDisplayData.length})
</Button>
```

### 4. 表格数据源
```typescript
// 文件：Receipts.tsx
// 位置：约第 4320 行

<Table
  dataSource={currentDisplayData as any}  // ← 关键修改
  // ...
/>
```

### 5. 筛选变化处理
```typescript
// 文件：Receipts.tsx
// 位置：约第 4360 行

onChange={(_pagination, filters, sorter, extra) => {
  setFilteredInfo(filters || {})
  setSortedInfo(sorter || {})
  
  if (extra.action === 'filter') {
    setTableFilteredData(extra.currentDataSource || [])
    setCurrentPage(1)
    setSelectedRowKeys([])  // ← 筛选后清空选择
  } else if (extra.action === 'sort') {
    setTableFilteredData(extra.currentDataSource || [])
  }
}}
```

## 状态管理

### 相关状态变量

```typescript
// 分页相关
const [currentPage, setCurrentPage] = useState(1)
const [pageSize, setPageSize] = useState(10)

// 筛选相关
const [filteredInfo, setFilteredInfo] = useState<Record<string, any>>({})
const [tableFilteredData, setTableFilteredData] = useState<any[]>([])
const [sortedInfo, setSortedInfo] = useState<any>({})  // ← 新增

// 选择相关
const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([])

// 顶部筛选
const [filters, setFilters] = useState({
  deletedStatus: 'normal',
  submittedStatus: 'all',
  volumeFilter: 'all',
  // ...
})
```

### 状态重置时机

```typescript
// 切换标签页时重置
useEffect(() => {
  setSelectedRowKeys([])      // 清空选择
  setCurrentPage(1)           // 回到第一页
  setTableFilteredData([])    // 清空列筛选
  setFilteredInfo({})         // 清空筛选信息
  setSortedInfo({})           // 清空排序信息
}, [activeTab])

// 列筛选时重置
if (extra.action === 'filter') {
  setCurrentPage(1)           // 回到第一页
  setSelectedRowKeys([])      // 清空选择
}
```

## 用户交互流程

### 场景1：纯列筛选

```
1. 用户进入页面
   → 显示所有数据（100条）
   
2. 用户点击"司机"列的筛选器
   → 选择"张三"
   
3. 系统响应
   → tableFilteredData = [筛选后的25条数据]
   → currentDisplayData = tableFilteredData (25条)
   → 分页显示：共 25 条
   → 全选按钮：全选筛选结果 (25)
   
4. 用户点击全选
   → 选中 25 条数据
   → 按钮显示：取消全选 (25)
```

### 场景2：顶部筛选 + 列筛选

```
1. 用户进入页面
   → 显示所有数据（100条）
   
2. 用户使用顶部筛选
   → 选择日期范围：2024-01-01 到 2024-01-31
   → 选择删除状态：正常
   
3. 系统响应
   → filteredReceipts = [符合条件的50条数据]
   → currentDisplayData = filteredReceipts (50条)
   → 分页显示：共 50 条
   
4. 用户再使用列筛选
   → 点击"司机"列筛选器，选择"张三"
   
5. 系统响应
   → tableFilteredData = [同时符合两个条件的15条数据]
   → currentDisplayData = tableFilteredData (15条)
   → 分页显示：共 15 条
   → 全选按钮：全选筛选结果 (15)
   
6. 用户点击全选
   → 选中 15 条数据（同时满足日期、状态、司机三个条件）
```

### 场景3：清除筛选

```
1. 用户已经筛选出15条数据
   → currentDisplayData = 15条
   
2. 用户清除列筛选
   → 点击筛选器的"重置"
   
3. 系统响应
   → tableFilteredData = []
   → currentDisplayData = filteredReceipts (50条，只有顶部筛选)
   → 分页显示：共 50 条
   
4. 用户清除顶部筛选
   → 点击"重置"按钮
   
5. 系统响应
   → filteredReceipts = 所有数据 (100条)
   → currentDisplayData = filteredReceipts (100条)
   → 分页显示：共 100 条
```

## 注意事项

### ⚠️ 重要提示

1. **数据一致性**
   - 所有数据操作必须基于 `currentDisplayData`
   - 不要直接使用 `receipts` 或 `matchedReceipts`

2. **状态同步**
   - 筛选变化时要同步更新相关状态
   - 切换标签页时要重置所有状态

3. **用户体验**
   - 操作后要有明确的提示信息
   - 按钮文本要清晰表明操作范围

4. **性能优化**
   - 使用 `useMemo` 缓存计算结果
   - 避免不必要的重新渲染

### ✅ 最佳实践

1. **使用统一数据源**
   ```typescript
   // ✅ 正确
   const total = currentDisplayData.length
   
   // ❌ 错误
   const total = receipts.length
   ```

2. **筛选后清空选择**
   ```typescript
   // ✅ 正确
   if (extra.action === 'filter') {
     setSelectedRowKeys([])
   }
   ```

3. **明确的用户提示**
   ```typescript
   // ✅ 正确
   message.success(`已全选 ${count} 条筛选数据`)
   
   // ❌ 不够清晰
   message.success(`已全选`)
   ```

