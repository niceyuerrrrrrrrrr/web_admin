# 充电单计算功能 - 测试指南

## 测试前准备

### 1. 确保充电站已配置电价规则
前往 **充电站管理** 页面（`/charging/stations`），确保：
- 充电站已创建
- 已配置时段电价规则
- 电价规则状态为"启用"
- 电价规则的生效日期包含测试数据的充电时间

### 2. 准备测试数据
确保充电单列表中有包含以下信息的测试数据：
- ✅ 充电站名称
- ✅ 充电时间（start_time）
- ✅ 充电电量（energy_kwh > 0）
- ✅ 识别金额（amount）

## 测试用例

### 用例1：正常计算流程

**步骤：**
1. 登录管理后台
2. 进入 **运营管理 > 充电管理 > 充电单列表**
3. 找到一条完整的充电单记录
4. 点击操作列的 **"计算金额"** 按钮

**预期结果：**
- ✅ 弹出"计算充电费用"对话框
- ✅ 显示充电站名称（蓝色高亮）
- ✅ 显示充电时间、电量等信息
- ✅ 显示电价规则说明

**步骤（续）：**
5. 点击 **"确定"** 按钮

**预期结果：**
- ✅ 显示loading状态
- ✅ 计算完成后弹出"计算结果"对话框
- ✅ 显示计算金额（金色）
- ✅ 显示计算单价（绿色，4位小数）
- ✅ 显示金额差异（带颜色和正负号）

**步骤（续）：**
6. 点击 **"应用计算结果"** 按钮
7. 在确认对话框中点击 **"确定"**

**预期结果：**
- ✅ 显示"更新成功"提示
- ✅ 对话框自动关闭
- ✅ 列表自动刷新
- ✅ 该充电单的"计算金额"和"计算单价"列显示新值

---

### 用例2：数据不完整 - 缺少充电站

**步骤：**
1. 找到一条 `charging_station` 为空的充电单
2. 点击 **"计算金额"** 按钮

**预期结果：**
- ✅ 显示警告提示："该充电单缺少充电站信息，无法计算"
- ✅ 不弹出计算对话框

---

### 用例3：数据不完整 - 缺少充电时间

**步骤：**
1. 找到一条 `start_time` 为空的充电单
2. 点击 **"计算金额"** 按钮

**预期结果：**
- ✅ 显示警告提示："该充电单缺少充电时间信息，无法计算"
- ✅ 不弹出计算对话框

---

### 用例4：数据不完整 - 电量无效

**步骤：**
1. 找到一条 `energy_kwh` 为0或空的充电单
2. 点击 **"计算金额"** 按钮

**预期结果：**
- ✅ 显示警告提示："该充电单缺少有效的电量信息，无法计算"
- ✅ 不弹出计算对话框

---

### 用例5：取消计算

**步骤：**
1. 点击 **"计算金额"** 按钮
2. 在"计算充电费用"对话框中点击 **"取消"** 按钮

**预期结果：**
- ✅ 对话框关闭
- ✅ 不执行计算
- ✅ 数据不变

---

### 用例6：取消应用结果

**步骤：**
1. 点击 **"计算金额"** 按钮
2. 点击 **"确定"** 完成计算
3. 在"计算结果"对话框中点击 **"取消"** 按钮

**预期结果：**
- ✅ 对话框关闭
- ✅ 计算结果不保存
- ✅ 充电单数据不变

---

### 用例7：重复计算

**步骤：**
1. 对同一条充电单执行计算并应用结果
2. 再次点击 **"计算金额"** 按钮
3. 查看"计算充电费用"对话框

**预期结果：**
- ✅ 显示"当前计算金额"字段，值为上次计算的结果
- ✅ 可以重新计算

**步骤（续）：**
4. 完成计算后查看"计算结果"对话框

**预期结果：**
- ✅ 显示"原计算金额"字段，值为上次的计算结果
- ✅ 可以对比新旧计算结果

---

### 用例8：金额差异显示

**测试正差异（识别金额 > 计算金额）：**
- ✅ 金额差异显示为红色
- ✅ 带"+"号前缀
- ✅ 例如：+￥5.50

**测试负差异（识别金额 < 计算金额）：**
- ✅ 金额差异显示为绿色
- ✅ 带"-"号前缀
- ✅ 例如：-￥3.20

**测试无差异（识别金额 = 计算金额）：**
- ✅ 金额差异显示为默认颜色
- ✅ 显示：￥0.00

---

### 用例9：API错误处理

**模拟场景：**
- 充电站没有配置电价规则
- 网络连接失败
- 服务器错误

**预期结果：**
- ✅ 显示错误提示信息
- ✅ 对话框不关闭（用户可以重试或取消）
- ✅ 数据不变

---

### 用例10：查看和编辑功能不受影响

**步骤：**
1. 点击 **"查看"** 按钮
2. 查看详情抽屉中的计算金额和单价
3. 关闭详情抽屉
4. 点击 **"编辑"** 按钮
5. 在编辑表单中查看和修改计算金额、单价

**预期结果：**
- ✅ 查看功能正常
- ✅ 编辑功能正常
- ✅ 计算功能与查看、编辑功能互不干扰

---

## 性能测试

### 测试1：计算响应时间
- 点击"计算金额"到显示结果的时间应 < 2秒
- 应用结果到列表刷新的时间应 < 1秒

### 测试2：大数据量
- 在包含100+条记录的列表中测试
- 计算功能应正常工作
- 列表刷新应流畅

---

## 兼容性测试

### 浏览器兼容性
- ✅ Chrome（最新版）
- ✅ Firefox（最新版）
- ✅ Safari（最新版）
- ✅ Edge（最新版）

### 屏幕尺寸
- ✅ 桌面端（1920x1080）
- ✅ 笔记本（1366x768）
- ✅ 小屏幕（1280x720）

---

## 回归测试

确保新功能不影响现有功能：

1. **列表功能**
   - ✅ 筛选功能正常
   - ✅ 排序功能正常
   - ✅ 分页功能正常
   - ✅ 导出功能正常

2. **选择功能**
   - ✅ 单选正常
   - ✅ 多选正常
   - ✅ 全选正常
   - ✅ 反选正常

3. **列配置**
   - ✅ 显示/隐藏列正常
   - ✅ 列顺序调整正常
   - ✅ 配置保存正常

---

## 测试数据示例

### 示例1：正常数据
```json
{
  "id": 1,
  "receipt_number": "CD20260126001",
  "vehicle_no": "冀A12345",
  "charging_station": "国家电网充电站",
  "charging_pile": "01号桩",
  "energy_kwh": 50.5,
  "amount": 65.00,
  "start_time": "2026-01-26 14:30:00",
  "end_time": "2026-01-26 16:00:00"
}
```

### 示例2：跨时段充电
```json
{
  "id": 2,
  "receipt_number": "CD20260126002",
  "vehicle_no": "冀B67890",
  "charging_station": "特来电充电站",
  "charging_pile": "05号桩",
  "energy_kwh": 80.0,
  "amount": 120.00,
  "start_time": "2026-01-26 17:45:00",
  "end_time": "2026-01-26 19:30:00"
}
```
*注：此数据跨越晚高峰和夜间时段，测试加权计算*

---

## 问题记录

| 问题ID | 描述 | 严重程度 | 状态 | 备注 |
|--------|------|----------|------|------|
| - | - | - | - | - |

---

## 测试结论

- [ ] 所有测试用例通过
- [ ] 性能符合要求
- [ ] 兼容性良好
- [ ] 无回归问题
- [ ] 可以发布

**测试人员：** ___________  
**测试日期：** ___________  
**测试环境：** ___________

