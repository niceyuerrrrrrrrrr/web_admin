# 删除逻辑说明文档

## 当前实现的删除逻辑

### 1. 软删除机制
所有删除操作都是**软删除**，不会真正删除数据：
- 设置 `deleted_at` 字段为删除时间
- 设置 `deleted_by` 字段为删除人ID
- 数据仍然保留在数据库中

### 2. 小程序端删除
**司机在小程序中删除票据**：
- 装料单、卸货单、充电单、水票、出厂单
- 删除后票据被标记为 `deleted_at`
- 票据状态变为"已删除"

### 3. 管理后台查看
**管理员在后台可以**：
- 通过"删除状态筛选器"查看已删除的票据
  - 全部：显示所有票据
  - 正常：只显示未删除的票据（默认）
  - 已删除：只显示已删除的票据
- 在列表中看到删除状态列
  - 绿色Tag "正常"
  - 红色Tag "已删除" + 删除时间 + 删除人

### 4. 装卸匹配删除（级联删除）
**超级管理员和统计员可以**：
- 删除装卸匹配记录
- 会同时软删除关联的装料单和卸货单
- 删除后可以在回收站恢复（API已实现）

---

## 当前没有实现的功能

### ❌ 回收站页面
- 目前没有独立的"回收站"页面
- 已删除的票据只能通过筛选器查看
- 没有批量恢复功能的UI

### ❌ 真正的删除（物理删除）
- 所有删除都是软删除
- 没有"永久删除"功能
- 数据会一直保留在数据库中

### ❌ 恢复功能UI
- 后端API已实现恢复功能
- 前端UI没有"恢复"按钮
- 无法在管理后台恢复已删除的票据

---

## 建议的完整流程

### 理想的删除流程应该是：

1. **司机删除（小程序）**
   - 司机在小程序中删除票据
   - 票据被软删除（标记 deleted_at）
   - 票据进入"待审核删除"状态

2. **管理员审核（管理后台）**
   - 超级管理员/统计员在后台查看已删除的票据
   - 可以选择：
     - **恢复**：取消删除，票据恢复正常
     - **确认删除**：移动到回收站
     - **永久删除**：真正删除数据（慎用）

3. **回收站**
   - 独立的回收站页面
   - 显示所有已确认删除的票据
   - 可以批量恢复或永久删除
   - 自动清理30天以上的数据

---

## 当前实际流程

### 现在的流程是：

1. **司机删除（小程序）**
   - 司机删除票据
   - 票据被软删除
   - ✅ 已实现

2. **管理员查看（管理后台）**
   - 通过筛选器查看已删除的票据
   - 只能查看，不能恢复或永久删除
   - ✅ 已实现（查看功能）
   - ❌ 未实现（恢复/删除功能）

3. **装卸匹配删除**
   - 超级管理员/统计员可以删除装卸匹配
   - 级联软删除关联的票据
   - ✅ 已实现（后端API）
   - ⚠️ 前端权限检查有问题

---

## 需要补充的功能

### 短期（紧急）
1. ✅ 修复装卸匹配删除的权限检查
2. ✅ 为装卸匹配列表添加删除状态列
3. ❌ 添加"恢复"按钮到已删除票据的操作列
4. ❌ 测试恢复功能是否正常工作

### 中期（重要）
1. ❌ 创建独立的"回收站"页面
2. ❌ 实现批量恢复功能
3. ❌ 实现批量永久删除功能
4. ❌ 添加删除审核流程

### 长期（优化）
1. ❌ 自动清理机制（30天后自动永久删除）
2. ❌ 删除日志和审计功能
3. ❌ 删除统计报表

---

## API接口状态

### 已实现的API
- ✅ `GET /api/v1/receipts?deleted_status=deleted` - 查询已删除票据
- ✅ `DELETE /api/v1/transport-match/{task_id}` - 删除装卸匹配（级联）
- ✅ `POST /api/v1/transport-match/{task_id}/restore` - 恢复装卸匹配（级联）
- ✅ `DELETE /api/v1/receipts/loading/{id}` - 删除装料单
- ✅ `DELETE /api/v1/receipts/departure/{id}` - 删除出厂单
- ✅ `DELETE /api/v1/receipts/unloading/{id}` - 删除卸货单
- ✅ `DELETE /api/v1/receipts/charging/{id}` - 删除充电单

### 未实现的API
- ❌ 恢复单个票据的API
- ❌ 永久删除票据的API
- ❌ 批量操作的API

---

## 总结

**当前状态**：
- 删除功能：✅ 基本实现（软删除）
- 查看功能：✅ 已实现
- 恢复功能：⚠️ 后端已实现，前端未实现
- 回收站：❌ 未实现
- 永久删除：❌ 未实现

**下一步建议**：
1. 先修复装卸匹配删除的权限问题
2. 添加"恢复"按钮到管理后台
3. 测试恢复功能
4. 再考虑是否需要独立的回收站页面
