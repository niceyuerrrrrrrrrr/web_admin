# 充电单列表功能增强说明

## 概述
为运营管理中的充电单列表添加了Ant Design原生列筛选、表头复选框下拉菜单和导出功能，提升数据管理和操作效率。

## 新增功能

### 1. 列筛选功能 ✅

#### 可筛选列
1. **司机** - 多选筛选，支持搜索
   - 显示所有不重复的司机姓名
   - 支持快速搜索定位

2. **车牌号** - 多选筛选，支持搜索
   - 显示所有不重复的车牌号
   - 支持快速搜索定位

3. **充电站** - 多选筛选，支持搜索
   - 显示所有不重复的充电站名称
   - 支持快速搜索定位

#### 排序功能
- **电量(kWh)** - 升序/降序排序
- **识别金额(元)** - 升序/降序排序
- **计算金额(元)** - 升序/降序排序
- **计算单价(元/kWh)** - 升序/降序排序
- **金额差异(元)** - 升序/降序排序
- **开始充电时间** - 时间排序
- **结束充电时间** - 时间排序
- **充电时长(分钟)** - 升序/降序排序

#### 使用方式
- 点击列标题右侧的筛选图标
- 勾选需要显示的选项
- 使用搜索框快速定位
- 点击"确定"应用筛选
- 点击"重置"清除筛选

---

### 2. 表头复选框下拉菜单 ✅

#### 位置
表格左上角复选框，点击旁边的下拉箭头显示菜单

#### 下拉选项
1. **全选所有数据** - 选中所有充电单记录（跨页）
2. **选择当前页** - 仅选中当前页的记录
3. **反选当前页** - 反选当前页的选中状态
4. **清空所有选择** - 清空所有已选记录

#### 功能特点
- 每个操作都有成功提示
- 显示已选记录数量
- 支持跨页选择
- 独立的选择状态管理

#### 选中后操作
显示蓝色提示条，展示：
- 已选记录数量
- "导出选中"按钮 - 快速导出选中数据
- "清空选择"按钮 - 快速清空选择

---

### 3. 导出功能 ✅

#### 3.1 导出全部数据
**按钮位置**: 表格右上角"导出全部"按钮

**导出字段**:
- 单据编号
- 车牌号
- 充电站
- 充电桩
- 电量(kWh)
- 识别金额(元)
- 计算金额(元)
- 计算单价(元/kWh)
- 金额差异(元)
- 开始充电时间
- 结束充电时间
- 充电时长(分钟)
- 创建时间

**文件命名**: `充电单数据_YYYY-MM-DD_HH-mm-ss.xlsx`

#### 3.2 导出选中数据
**按钮位置**: 选中记录后，提示条中的"导出选中"按钮

**功能特点**:
- 只导出选中的记录
- 导出字段与全部导出相同
- 文件名包含选中数量

**文件命名**: `充电单数据_选中N条_YYYY-MM-DD_HH-mm-ss.xlsx`

**特殊处理**:
- 金额差异自动计算（识别金额 - 计算金额）
- 时间格式化为 `YYYY-MM-DD HH:mm`
- 空值统一显示为空字符串或 0

---

## 技术实现

### 1. 状态管理

```typescript
const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([])
const [currentPage, setCurrentPage] = useState(1)
const [pageSize, setPageSize] = useState(20)
```

### 2. 列筛选配置

```typescript
{
  title: '司机',
  dataIndex: 'driver_name',
  key: 'driver_name',
  width: 120,
  filters: driverOptions.map((v) => ({ text: v, value: v })),
  filteredValue: filters.driverName ? [filters.driverName] : null,
  filterSearch: true, // 启用搜索功能
}
```

### 3. 表头复选框配置

```typescript
rowSelection={{
  selectedRowKeys,
  onChange: setSelectedRowKeys,
  columnWidth: 48,
  selections: [
    {
      key: 'select-all-data',
      text: '全选所有数据',
      onSelect: () => {
        const allKeys = receipts.map((record) => record.id)
        setSelectedRowKeys(allKeys)
        message.success(`已全选 ${allKeys.length} 条数据`)
      },
    },
    // ... 其他选项
  ],
}}
```

### 4. 导出函数

```typescript
// 导出全部
const handleExport = useCallback(() => {
  if (!receipts.length) {
    message.warning('没有数据可导出')
    return
  }
  // 数据转换和导出逻辑
}, [receipts, message])

// 导出选中
const handleExportSelected = useCallback(() => {
  if (selectedRowKeys.length === 0) {
    message.warning('请先选择要导出的数据')
    return
  }
  const selectedReceipts = receipts.filter((r) => selectedRowKeys.includes(r.id))
  // 数据转换和导出逻辑
}, [receipts, selectedRowKeys, message])
```

---

## 用户界面变化

### 新增元素
1. **表格左上角复选框**（带下拉菜单）
2. **列标题筛选图标**（司机、车牌号、充电站）
3. **选中记录提示条**（蓝色背景）
4. **导出全部按钮**（表格右上角）
5. **导出选中按钮**（提示条中）

### 布局调整
- 表格宽度设置为 2200px，支持横向滚动
- 操作列固定在右侧
- 分页器显示总数和页码选择器
- 支持每页显示 10/20/50/100 条记录

---

## 数据处理特点

### 1. 金额差异计算
```typescript
const diff = (r.amount !== null && r.calculated_amount !== null)
  ? (r.amount - r.calculated_amount)
  : (r.amount_difference ?? null)
```

### 2. 时间格式化
```typescript
r.start_time ? dayjs(r.start_time).format('YYYY-MM-DD HH:mm') : ''
```

### 3. 空值处理
- 数值字段：显示为 0 或空字符串
- 文本字段：显示为空字符串
- 确保导出数据的一致性

---

## 使用场景

### 场景1: 按充电站导出数据
1. 点击"充电站"列的筛选图标
2. 勾选特定充电站
3. 点击"确定"应用筛选
4. 点击表头复选框下拉菜单，选择"全选所有数据"
5. 点击"导出选中"按钮
6. 获得该充电站的充电单Excel文件

### 场景2: 导出特定车辆的充电记录
1. 点击"车牌号"列的筛选图标
2. 在搜索框输入车牌号快速定位
3. 勾选目标车牌号
4. 点击"确定"应用筛选
5. 点击"导出全部"按钮
6. 获得该车辆的充电记录Excel文件

### 场景3: 查看金额差异较大的记录
1. 点击"金额差异(元)"列标题进行排序
2. 查看差异最大的记录
3. 选中需要关注的记录
4. 点击"导出选中"按钮
5. 获得异常记录的Excel文件

---

## 与其他页面的一致性

充电单列表的功能实现与以下页面保持一致：
- ✅ 票据列表
- ✅ 审批管理中心
- ✅ 报销管理
- ✅ 采购管理
- ✅ 请假管理
- ✅ 物品领用管理
- ✅ 文档证件管理
- ✅ 库存管理

所有页面都采用相同的：
- 列筛选交互方式
- 表头复选框下拉菜单
- 导出功能实现
- 用户体验设计

---

## 构建验证

✅ **构建成功** - 所有修改已通过 TypeScript 编译和 Vite 构建验证

```bash
✓ 5959 modules transformed.
✓ built in 6.47s
```

---

## 测试建议

### 功能测试
1. **列筛选功能**
   - 测试单列筛选
   - 测试多列组合筛选
   - 测试搜索功能
   - 测试筛选后的数据准确性
   - 测试重置筛选功能

2. **复选框下拉菜单**
   - 测试全选所有数据
   - 测试选择当前页
   - 测试反选当前页
   - 测试清空所有选择
   - 测试跨页选择

3. **导出功能**
   - 测试空数据导出（应显示警告）
   - 测试全量数据导出
   - 测试选中数据导出
   - 验证导出文件的字段完整性
   - 验证金额差异计算准确性

### 边界测试
1. **大数据量** - 测试1000+条记录的导出和筛选
2. **特殊字符** - 测试包含特殊字符的充电站名称
3. **空值处理** - 测试各种空值情况
4. **分页切换** - 测试选中状态在分页切换时的保持

---

## 后续优化建议

1. **高级筛选** - 支持金额范围筛选（如金额差异 > 10元）
2. **筛选保存** - 支持保存常用筛选条件
3. **批量操作** - 支持批量编辑、批量删除
4. **导出模板** - 支持自定义导出字段和顺序
5. **导出格式** - 支持CSV、PDF等多种格式
6. **数据统计** - 在选中记录时显示统计信息（总金额、平均单价等）

---

## 总结

本次更新为充电单列表添加了完整的列筛选、批量选择和数据导出功能，大幅提升了数据管理效率。所有功能都遵循Ant Design的设计规范，与现有页面保持一致的用户体验。

**修改文件**: `/Users/niesiyu/Desktop/web-admin/src/pages/ChargingList.tsx`
**新增代码行数**: 约150行
**功能完整性**: ✅ 列筛选 + ✅ 复选框菜单 + ✅ 导出全部 + ✅ 导出选中

