# 权限管理系统使用说明

## 概述

权限管理系统已集成到管理后台，提供完整的角色和权限配置功能。

**访问路径**: 系统管理 → 权限管理 (`/permissions`)

---

## 功能特性

### 1. 角色管理

#### 1.1 查看角色列表
- 显示所有系统角色和自定义角色
- 查看角色的权限数量、状态、类型
- 系统角色带有🔒标识，不可删除

#### 1.2 创建角色
1. 点击「新建角色」按钮
2. 填写角色信息：
   - **角色代码**: 唯一标识，只能包含小写字母和下划线（如：`custom_role`）
   - **角色名称**: 显示名称（如：自定义角色）
   - **描述**: 角色说明
   - **状态**: 启用/禁用
3. 勾选需要的权限
4. 点击「确定」保存

#### 1.3 编辑角色
1. 点击角色行的「编辑」按钮
2. 修改角色名称、描述、状态
3. 调整权限配置
4. 保存更改

**注意**: 系统角色的代码不可修改

#### 1.4 删除角色
1. 点击自定义角色的「删除」按钮
2. 确认删除操作

**限制**: 系统角色不可删除

#### 1.5 查看角色权限
点击「查看权限」按钮，在右侧抽屉中查看：
- 角色基本信息
- 完整的权限列表

---

### 2. 权限列表

#### 2.1 权限表格视图
显示所有系统权限，包括：
- **权限代码**: 唯一标识（如：`receipt.upload`）
- **权限名称**: 显示名称
- **模块**: 所属模块
- **类型**: 
  - `menu` - 菜单权限（蓝色）
  - `action` - 操作权限（绿色）
  - `data` - 数据权限（橙色）
- **父级权限**: 权限层级关系
- **描述**: 权限说明
- **状态**: 启用/禁用

#### 2.2 权限树视图
以树形结构展示权限层级：
- 按模块分组
- 显示父子关系
- 便于理解权限结构

---

## 权限模块说明

| 模块 | 代码 | 说明 |
|-----|------|------|
| 票据管理 | `receipt` | 票据上传、查看、编辑、删除 |
| 考勤打卡 | `clock` | 打卡、考勤统计、考勤管理 |
| 数据统计 | `statistics` | 查看统计、导出报表 |
| 财务管理 | `finance` | 报销、定价、工资管理 |
| 高级功能 | `advanced` | 户名管理、距离记录等 |
| 系统管理 | `admin` | 用户管理、角色管理、权限管理 |

---

## 系统角色

| 角色 | 代码 | 权限数 | 说明 |
|-----|------|--------|------|
| 超级管理员 | `super_admin` | 28 | 拥有所有权限 |
| 总经理 | `general_manager` | 28 | 公司管理层，拥有所有权限 |
| 财务 | `finance` | 20 | 财务相关权限 |
| 车队长 | `team_leader` | 16 | 车队管理权限 |
| 统计 | `statistics` | 11 | 统计查看权限 |
| 司机 | `driver` | 9 | 基本操作权限 |

---

## 使用场景

### 场景 1: 创建自定义角色

**需求**: 创建一个"财务助理"角色，只能查看财务数据，不能审批

**步骤**:
1. 点击「新建角色」
2. 填写：
   - 角色代码: `finance_assistant`
   - 角色名称: 财务助理
   - 描述: 财务部门助理，只能查看数据
3. 勾选权限：
   - ✅ `finance` - 财务管理
   - ✅ `finance.reimbursement` - 报销申请
   - ✅ `finance.view_all` - 查看所有财务
   - ❌ `finance.reimbursement_approve` - 报销审批（不勾选）
4. 保存

### 场景 2: 调整现有角色权限

**需求**: 给车队长添加户名管理权限

**步骤**:
1. 找到「车队长」角色，点击「编辑」
2. 在权限配置中找到「高级功能」模块
3. 勾选：
   - ✅ `advanced.transport_accounts` - 户名管理
   - ✅ `advanced.transport_accounts.view` - 查看户名
   - ✅ `advanced.transport_accounts.create` - 添加户名
4. 保存

### 场景 3: 临时禁用角色

**需求**: 临时禁用某个自定义角色

**步骤**:
1. 点击角色的「编辑」按钮
2. 取消勾选「启用」复选框
3. 保存

---

## 权限代码规范

权限代码采用 `模块.功能.操作` 的层级结构：

```
receipt.upload          # 票据模块 - 上传
receipt.view_all        # 票据模块 - 查看所有
finance.pricing         # 财务模块 - 定价
admin.users             # 管理模块 - 用户管理
```

### 权限继承

拥有父级权限会自动拥有所有子权限：
- 拥有 `receipt` → 自动拥有 `receipt.view`, `receipt.upload` 等

---

## 注意事项

### ⚠️ 系统角色限制
- 系统角色（带🔒标识）不可删除
- 系统角色的代码不可修改
- 可以修改系统角色的权限配置

### ⚠️ 权限生效
- 权限变更后，用户需要重新登录才能生效
- 或在小程序中调用 `permissionService.loadPermissions()` 刷新

### ⚠️ 删除角色
- 删除角色前，请确保没有用户使用该角色
- 删除操作不可恢复

### ⚠️ 权限设计
- 权限应该遵循最小权限原则
- 避免给予过多不必要的权限
- 定期审查和调整角色权限

---

## API 接口

权限管理页面使用以下 API：

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/v1/permissions` | GET | 获取权限列表 |
| `/api/v1/permissions/roles` | GET | 获取角色列表 |
| `/api/v1/permissions/roles` | POST | 创建角色 |
| `/api/v1/permissions/roles/{id}` | PUT | 更新角色 |
| `/api/v1/permissions/roles/{id}` | DELETE | 删除角色 |

---

## 技术栈

- **前端框架**: React 19 + TypeScript
- **UI 组件**: Ant Design 5
- **状态管理**: TanStack Query (React Query)
- **HTTP 客户端**: Axios
- **路由**: React Router

---

## 常见问题

### Q1: 为什么我看不到权限管理菜单？
A: 需要拥有 `admin.permissions` 权限才能访问权限管理页面。

### Q2: 如何给用户分配角色？
A: 在「用户管理」页面，编辑用户时可以分配角色。

### Q3: 权限变更后多久生效？
A: 需要用户重新登录，或在小程序中刷新权限。

### Q4: 可以创建多少个自定义角色？
A: 没有数量限制，但建议控制在合理范围内。

### Q5: 如何查看某个用户的权限？
A: 在「用户管理」页面，查看用户详情可以看到其角色和权限。

---

## 更新日志

### 2024-12-15
- ✅ 初始版本发布
- ✅ 支持角色 CRUD 操作
- ✅ 支持权限查看（表格和树形视图）
- ✅ 支持角色权限配置
- ✅ 添加户名管理权限（5个）

---

**文档版本**: 1.0.0  
**最后更新**: 2024-12-15
