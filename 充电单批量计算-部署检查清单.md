# 充电单批量计算功能 - 部署检查清单

## ✅ 部署前检查

### 1. 前端代码检查

- [x] `ChargingList.tsx` 已添加批量计算状态
- [x] `ChargingList.tsx` 已添加批量计算函数
- [x] `ChargingList.tsx` 已添加批量结果对话框
- [x] `types.ts` 已更新 `ChargingCostResult` 类型
- [x] 添加了 `rule_effective_date` 字段
- [x] 添加了 `rule_expiry_date` 字段
- [x] 添加了 `time_period` 字段

### 2. 后端代码检查

- [x] 后端自动计算功能已部署
- [x] 充电单创建时自动计算
- [x] 支持充电站名称模糊匹配
- [x] 计算失败不影响充电单创建
- [x] 已删除重复的 `calculated_amount` 字段
- [x] 已删除装料单中的 `calculated_amount` 字段
- [x] 已删除卸料单中的 `calculated_amount` 字段

### 3. API 接口检查

- [x] `/api/v1/charging-pricing/calculate` 接口正常
- [x] `/api/v1/receipts/charging/{id}` 更新接口正常
- [x] 返回数据包含 `calculated_amount`
- [x] 返回数据包含 `calculated_price`
- [x] 返回数据包含 `calculated_unit_price`

---

## 🚀 部署步骤

### 步骤1：前端部署

```bash
cd /Users/niesiyu/Desktop/web-admin

# 1. 检查代码
git status

# 2. 构建生产版本
npm run build

# 3. 部署到服务器
# （根据你的部署方式）
```

### 步骤2：后端验证

```bash
# 连接到服务器
ssh admin@47.108.135.142

# 检查服务状态
sudo systemctl status miniprogram-user-api

# 查看最近日志
sudo journalctl -u miniprogram-user-api -n 50 --no-pager

# 验证充电单列表API
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://127.0.0.1:8100/api/v1/receipts?receipt_type=charging"
```

### 步骤3：功能测试

**测试1：单条计算**
- [ ] 打开充电单列表
- [ ] 点击单条记录的"计算金额"按钮
- [ ] 验证显示电价表
- [ ] 验证计算结果正确
- [ ] 验证应用结果成功

**测试2：批量计算（小批量）**
- [ ] 选择3条充电单
- [ ] 点击"批量计算金额"
- [ ] 验证显示计算进度
- [ ] 验证显示结果对话框
- [ ] 验证成功/失败统计正确
- [ ] 验证计算单价显示
- [ ] 验证生效日期显示
- [ ] 验证金额差异计算正确

**测试3：批量计算（大批量）**
- [ ] 选择20条充电单
- [ ] 点击"批量计算金额"
- [ ] 验证实时进度显示
- [ ] 验证计算完成后统计正确
- [ ] 验证结果表格分页正常

**测试4：选择性应用**
- [ ] 在结果对话框中取消勾选部分结果
- [ ] 点击"应用选中的计算结果"
- [ ] 验证只更新选中的充电单
- [ ] 验证列表自动刷新
- [ ] 验证数据库已更新

**测试5：失败处理**
- [ ] 选择缺少充电站信息的充电单
- [ ] 批量计算
- [ ] 验证显示失败状态
- [ ] 验证显示错误信息
- [ ] 验证无法勾选失败项

**测试6：数据验证**
- [ ] 验证计算金额准确
- [ ] 验证计算单价准确
- [ ] 验证生效日期正确
- [ ] 验证金额差异计算正确
- [ ] 对比实际票据验证

---

## 🔍 验证清单

### 前端验证

```bash
# 1. 检查浏览器控制台
# 应该没有错误信息

# 2. 检查网络请求
# 批量计算时应该看到多个 POST 请求到 /charging-pricing/calculate

# 3. 检查数据格式
# 返回的数据应该包含 rule_effective_date
```

### 后端验证

```bash
# 1. 检查服务日志
sudo journalctl -u miniprogram-user-api -f

# 应该看到类似的日志：
# INFO: "POST /api/v1/charging-pricing/calculate HTTP/1.0" 200 OK
# INFO: "PUT /api/v1/receipts/charging/123 HTTP/1.0" 200 OK

# 2. 检查数据库
mysql -u nocobase -p nocobase -e "
SELECT id, station_name, energy_consumed, total_amount, 
       calculated_amount, calculated_price
FROM charging_receipts 
WHERE calculated_amount IS NOT NULL
ORDER BY updated_at DESC 
LIMIT 5;
"

# 3. 验证字段映射
# calculated_amount 应该有值
# calculated_price 应该有值
```

---

## ⚠️ 常见问题排查

### 问题1：批量计算按钮不显示

**检查：**
- [ ] 是否选中了充电单
- [ ] 浏览器是否已刷新
- [ ] 前端代码是否已部署

**解决：**
```bash
# 强制刷新浏览器
Ctrl + F5

# 清除浏览器缓存
```

### 问题2：计算失败

**检查：**
- [ ] 充电站信息是否完整
- [ ] 充电站是否配置了电价规则
- [ ] 充电时间是否在电价规则有效期内

**解决：**
```bash
# 查询充电站
mysql -u nocobase -p nocobase -e "
SELECT * FROM charging_stations 
WHERE station_name LIKE '%中建西部%';
"

# 查询电价规则
mysql -u nocobase -p nocobase -e "
SELECT * FROM charging_price_rules 
WHERE station_id = <充电站ID> AND is_active = 1;
"
```

### 问题3：应用结果失败

**检查：**
- [ ] 网络连接是否正常
- [ ] 后端服务是否运行
- [ ] 用户是否有权限

**解决：**
```bash
# 检查服务状态
sudo systemctl status miniprogram-user-api

# 查看错误日志
sudo journalctl -u miniprogram-user-api -n 100 --no-pager | grep -i error
```

### 问题4：数据不刷新

**检查：**
- [ ] 是否点击了"应用"按钮
- [ ] 是否有错误提示
- [ ] 浏览器是否已刷新

**解决：**
```bash
# 手动刷新页面
F5 或 Ctrl + R

# 检查浏览器控制台是否有错误
```

---

## 📊 性能监控

### 监控指标

**1. 计算速度**
```
单条计算时间：< 1秒
20条批量计算：< 30秒
50条批量计算：< 60秒
```

**2. 成功率**
```
目标成功率：> 95%
失败原因统计：
- 充电站信息缺失：< 3%
- 电价规则未配置：< 1%
- 其他错误：< 1%
```

**3. 用户体验**
```
进度显示：实时更新
结果展示：< 1秒
应用结果：< 5秒
```

### 监控命令

```bash
# 查看API响应时间
sudo journalctl -u miniprogram-user-api --since "1 hour ago" | \
  grep "charging-pricing/calculate" | \
  grep -oP '\d+ms' | \
  awk '{sum+=$1; count++} END {print "平均响应时间:", sum/count, "ms"}'

# 查看成功率
sudo journalctl -u miniprogram-user-api --since "1 hour ago" | \
  grep "charging-pricing/calculate" | \
  grep -c "200 OK"

# 查看失败率
sudo journalctl -u miniprogram-user-api --since "1 hour ago" | \
  grep "charging-pricing/calculate" | \
  grep -c "500\|400\|404"
```

---

## 📝 回滚计划

### 如果出现严重问题

**前端回滚：**
```bash
cd /Users/niesiyu/Desktop/web-admin

# 回滚到上一个版本
git revert HEAD

# 重新构建
npm run build

# 重新部署
```

**后端回滚：**
```bash
ssh admin@47.108.135.142

# 恢复备份
cd /opt/miniprogram-user-api
sudo cp api/routers/receipts.py.backup.20260126_162722 api/routers/receipts.py

# 重启服务
sudo systemctl restart miniprogram-user-api
```

---

## ✅ 部署完成确认

### 最终检查清单

- [ ] 前端代码已部署
- [ ] 后端服务运行正常
- [ ] 单条计算功能正常
- [ ] 批量计算功能正常
- [ ] 选择性应用功能正常
- [ ] 错误处理正常
- [ ] 数据刷新正常
- [ ] 性能符合预期
- [ ] 用户体验良好
- [ ] 文档已更新

### 通知相关人员

```
✅ 充电单批量计算功能已部署完成

新功能：
1. 支持多选充电单批量计算金额
2. 显示计算单价和生效日期
3. 支持选择性应用计算结果
4. 实时显示计算进度

使用方法：
1. 在充电单列表选择多条记录
2. 点击"批量计算金额"按钮
3. 查看计算结果并选择要应用的项
4. 点击"应用选中的计算结果"

注意事项：
- 充电单必须有充电站和电量信息
- 充电站必须配置了电价规则
- 建议每次不超过20-30条

如有问题请联系技术支持。
```

---

## 📈 后续优化

### 短期优化（1-2天）

- [ ] 添加计算进度条（百分比）
- [ ] 优化错误提示信息
- [ ] 添加计算时间估算

### 中期优化（1周）

- [ ] 支持取消批量计算
- [ ] 添加计算历史记录
- [ ] 支持导出计算结果

### 长期优化（1个月）

- [ ] 并发计算优化（提高速度）
- [ ] 智能推荐需要重新计算的充电单
- [ ] 自动检测电价规则变更并提醒

---

*充电单批量计算功能 - 部署检查清单 v1.0*  
*创建时间：2026-01-26*  
*状态：✅ 准备就绪*

